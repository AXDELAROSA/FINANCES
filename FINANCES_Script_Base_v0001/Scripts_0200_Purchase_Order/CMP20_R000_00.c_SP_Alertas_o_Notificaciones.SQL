-- //////////////////////////////////////////////////////////////
-- // ARCHIVO:			
-- //////////////////////////////////////////////////////////////
-- // BASE DE DATOS:	[BD_GENERAL]
-- // MODULO:			MENU
-- // OPERACION:		VERIFICAR ALERTAS
-- //////////////////////////////////////////////////////////////
-- // Autor:			AX
-- // Fecha creación:	20200917
-- ////////////////////////////////////////////////////////////// 

USE [COMPRAS] 
GO

-- //////////////////////////////////////////////////////////////
-- //	STORED PROCEDURE ---> PARA MOSTRAR ALERTAS 
-- //	DE ORDENES PENDIENTES.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_ALERTAS_64]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_ALERTAS_64]
GO
--		 EXECUTE [dbo].[PG_SK_ALERTAS_64] 0,41,6003
--		 EXECUTE [dbo].[PG_SK_ALERTAS_64] 0,44,6003
--		 EXECUTE [dbo].[PG_SK_ALERTAS_64] 0,47,6003
--		 EXECUTE [dbo].[PG_SK_ALERTAS_64] 0,144,6003
--		 EXECUTE [dbo].[PG_SK_ALERTAS_64] 0,139,6003
CREATE PROCEDURE [dbo].[PG_SK_ALERTAS_64]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_GRUPO_APROBADOR			INT
AS
	DECLARE  @VP_MENSAJE			VARCHAR(300) = ''
			,@VP_EXISTE_01			INT
			,@VP_EXISTE_03			INT
			,@VP_PENDIENTES			INT	= 0
-- ///////////////////////////////////////////			
--	IF	@PP_K_GRUPO_APROBADOR	=	6003
--	BEGIN	
	SELECT		@VP_EXISTE_01					= COUNT(K_USUARIO)
	FROM		BD_GENERAL.DBO.GRUPO_APROBADOR		(NOLOCK)
				-- =============================
	WHERE		K_USUARIO					= @PP_K_USUARIO_ACCION
	AND			K_TIPO_GRUPO_APROBADOR		= 6001	--@PP_K_GRUPO_APROBADOR
	AND			K_ESTATUS_GRUPO_APROBADOR	=	1

	-- =============================	-- =============================	

	SELECT		@VP_EXISTE_03					= COUNT(K_USUARIO)
	FROM		BD_GENERAL.DBO.GRUPO_APROBADOR		(NOLOCK)
				-- =============================
	WHERE		K_USUARIO					= @PP_K_USUARIO_ACCION
	AND			K_TIPO_GRUPO_APROBADOR		= 6003	--@PP_K_GRUPO_APROBADOR
	AND			K_ESTATUS_GRUPO_APROBADOR	=	1


	IF @VP_EXISTE_01	> 0
	BEGIN
		SELECT	@VP_PENDIENTES						=	COUNT(K_HEADER_PURCHASE_ORDER)
		FROM	COMPRAS.DBO.HEADER_PURCHASE_ORDER		(NOLOCK)
		WHERE	K_STATUS_PURCHASE_ORDER				=	4
		AND		L_BORRADO							=	0
	END
	ELSE IF @VP_EXISTE_03	> 0
	BEGIN
		SELECT	@VP_PENDIENTES						=	COUNT(K_HEADER_PURCHASE_ORDER)
		FROM	COMPRAS.DBO.HEADER_PURCHASE_ORDER	(NOLOCK)
		INNER JOIN	BD_GENERAL.DBO.USUARIO_PEARL	(NOLOCK)	ON USUARIO_PEARL.K_EMPLEADO_PEARL	= HEADER_PURCHASE_ORDER.K_APPROVED_BY
		WHERE	K_STATUS_PURCHASE_ORDER				=	2
		AND		K_USUARIO_PEARL						=	@PP_K_USUARIO_ACCION
		AND		HEADER_PURCHASE_ORDER.L_BORRADO		=	0
	END
	ELSE
	BEGIN
		SET	@VP_PENDIENTES	= 0
	END
	
	IF @VP_PENDIENTES	> 0
	BEGIN
		SET @VP_MENSAJE = 'Existen [ORDENES DE COMPRA] por autorizar. Da click aquí par ingresar a la pantalla.'
	END

--	END
	SELECT  @VP_MENSAJE AS MENSAJE, 'COMPRAS' AS TITULO_UDA
	-- ////////////////////////////////////////////////////////////////////
GO

--				select * from HEADER_PURCHASE_ORDER WHERE K_STATUS_PURCHASE_ORDER =2 AND L_BORRADO=0
--				select HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER, D_STATUS_PURCHASE_ORDER, L_BORRADO 
--				from HEADER_PURCHASE_ORDER, STATUS_PURCHASE_ORDER
--				WHERE L_BORRADO=1
--				AND HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
--				
--				
--				
--				
--				SELECT	COUNT(K_HEADER_PURCHASE_ORDER)
--				FROM	COMPRAS.DBO.HEADER_PURCHASE_ORDER
--				WHERE	K_STATUS_PURCHASE_ORDER	=	4
--				AND		L_BORRADO				=	0
--				
--				SELECT	COUNT(K_HEADER_PURCHASE_ORDER)
--				FROM	COMPRAS.DBO.HEADER_PURCHASE_ORDER
--				WHERE	K_STATUS_PURCHASE_ORDER	=	2
--				AND		K_APPROVED_BY			=	22
--				AND		L_BORRADO				=	0