-- //////////////////////////////////////////////////////////////
-- // DATA BASE:		COMPRAS
-- // MODULE:			HEADER_PURCHASE_ORDER
-- // OPERATION:		SP'S
-- //////////////////////////////////////////////////////////////
-- // AUTHOR:			AX DE LA ROSA			
-- // CREATION DATE:	20200206
-- ////////////////////////////////////////////////////////////// 

USE [COMPRAS]
GO

-- //////////////////////////////////////////////////////////////
-- ////////////	CONTENIDO DEL SP
--	[PG_LI_HEADER_PURCHASE_ORDER]
--	[PG_LI_APPROVE_MANAGER]
--	[PG_LI_APPROVE_FINANCES]
--	[PG_SK_HEADER_PURCHASE_ORDER]
--	[PG_SK_DETAILS_PURCHASE_ORDER]
--	[PG_SK_DETAILS_LOG]
--	[PG_SK_ISSUED]
--	[PG_SK_PERMISOS_PO]
--	[PG_SK_VERIFICAR_ESTATUS_PO]
--	[PG_SK_COMENTARIOS_LOG_PO]
--	[PG_IN_HEADER_PURCHASE_ORDER]
--	[PG_IN_DETAILS_PURCHASE_ORDER]
--	[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]
--	[PG_IN_COMENTARIOS_LOG_PO]
--	[PG_UP_HEADER_PURCHASE_ORDER]
--	[PG_UP_HEADER_PURCHASE_ORDER_FINANCES]
--	[PG_UP_HEADER_PURCHASE_ORDER_TAXRATE]
--	[PG_UP_CLOSE_PARTIAL]
--	[PG_UP_CANCEL_PO]
--	[PG_UP_DETAILS_RECEIVED]
--	[PG_UP_DATE_RECEIVED_PO]
--	[PG_UP_ESTATUS_PO_SEND_REVIEW]
--	[PG_UP_ESTATUS_PO_MANAGER_DPTO]
--	[PG_PR_ENVIAR_CORREO_FINANZAS]
--	[PG_PR_ENVIAR_CORREO_USUARIOS]
--	[PG_UP_ESTATUS_PO_SEND_PRINT]
--	[PG_DL_HEADER_PURCHASE_ORDER]
--	[PG_DL_DETAILS_LOG]

-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / LISTADO
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_LI_HEADER_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_LI_HEADER_PURCHASE_ORDER]
GO
-- EXECUTE [dbo].[PG_LI_HEADER_PURCHASE_ORDER] 0,139,'',-1,-1,-1,null,null
-- EXECUTE [dbo].[PG_LI_HEADER_PURCHASE_ORDER] 0,157, '' , -1 , -1 , -1 , '2020-06-08' , '2020-09-10'
-- EXECUTE [dbo].[PG_LI_HEADER_PURCHASE_ORDER] 0,41, '' , -1 , -1 , -1 , '2020-06-08' , '2020-09-10'
-- EXECUTE [dbo].[PG_LI_HEADER_PURCHASE_ORDER] 0,150, '' , -1 , -1 , -1 , '2020-06-08' , '2020-09-30'
--SELECT * FROM		HEADER_PURCHASE_ORDER WHERE K_USUARIO_ALTA=150			-- =3
CREATE PROCEDURE [dbo].[PG_LI_HEADER_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_BUSCAR						VARCHAR(25),
	@PP_K_STATUS_PURCHASE_ORDER		INT,
	@PP_K_VENDOR					INT,
	@PP_K_CURRENCY					INT,
	@PP_F_INIT						DATE,
	@PP_F_FINISH					DATE,
	@PP_L_EDIT_PO_DEPTS				INT=0
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	DECLARE @VP_L_APLICAR_MAX_ROWS	INT=1		
	DECLARE @VP_K_APPROVED_BY		INT
	DECLARE @VP_LI_N_REGISTROS		INT =5000
	-- ///////////////////////////////////////////
	-- =========================================		
	DECLARE @VP_K_FOLIO				INT
	EXECUTE [BD_GENERAL].DBO.[PG_RN_OBTENER_ID_X_REFERENCIA]			
								@PP_BUSCAR,	@OU_K_ELEMENTO = @VP_K_FOLIO	OUTPUT
-- =========================================		
	SELECT	TOP (1)
	--SE OBTIENE LA K_GERENTE PARA LISTAR LAS ORDENES DEL MISMO DEPARTAMENTO.
	@VP_K_APPROVED_BY=
		(	CASE
				WHEN	EN_NUM_DEPT IN (1)			THEN	(7945)			-- RH					PATRICIACH
				WHEN	EN_NUM_DEPT IN (2,5,6,11)	THEN	(22)			-- PRODUCCION			GUILLERMOM
-- CAMBIO_FIRMA			--WHEN	EN_NUM_DEPT IN (2,6,11)		THEN	(22)			-- PRODUCCION			GUILLERMOM
-- CAMBIO_FIRMA			--WHEN	EN_NUM_DEPT IN (5)			THEN	(11928)			-- MANTENIMIENTO		OMARG	(156)
				WHEN	EN_NUM_DEPT IN (3)			THEN	(4475)			-- MATERIALES			MANUELG
				WHEN	EN_NUM_DEPT IN (4)			THEN	(1299)			-- CALIDAD				MIGUELC
-- CAMBIO_FIRMA			--WHEN	EN_NUM_DEPT IN (7,12)		THEN	(181)			-- PROYECTOS			OMARD
				WHEN	EN_NUM_DEPT IN (12)			THEN	(181)			-- PROYECTOS			OMARD			-- CAMBIO_FIRMA
				WHEN	EN_NUM_DEPT IN (7)			THEN	(6142)			-- SISTEMAS				RAFAELF	(41)	-- CAMBIO_FIRMA
				WHEN	EN_NUM_DEPT IN (8)			THEN	(67)			-- FINANZAS				ADRIANAD
				WHEN	EN_NUM_DEPT IN (9)			THEN	(52)			-- GERENTE				JORGEH
		END )
		FROM    BD_GENERAL.DBO.USUARIO_PEARL	(NOLOCK)
		LEFT JOIN HOWE.DBO.VISTA_GAFETES ON EN_NUM_EMP=K_EMPLEADO_PEARL
		WHERE	L_BORRADO=0
		AND		USUARIO_PEARL.K_USUARIO_PEARL=@PP_K_USUARIO_ACCION

	IF @PP_K_USUARIO_ACCION=139	-- or @PP_K_USUARIO_ACCION=57
	BEGIN
		SET @VP_K_APPROVED_BY = -1
	END
	-- =========================================
IF @PP_L_EDIT_PO_DEPTS	= 0
BEGIN
	SELECT		TOP (@VP_LI_N_REGISTROS)
				CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
				-- =============================	 
				F_DATE_PURCHASE_ORDER AS [DATE],
				F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
				F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
				F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
				-- =============================	 
				S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
				D_VENDOR,
				S_PLACED_BY	, D_PLACED_BY,
				S_TERMS		, D_TERMS	 ,				
				S_CURRENCY	, D_CURRENCY,
				D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
				-- =============================	
				(	CASE
					WHEN L_IS_BLANKET = 1 THEN 'SI'
					ELSE	'NO'
					END				)	AS SINO_BLANKET,
				-- =============================
				HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
				S_STATUS_PAID_ORDER,
				D_STATUS_PAID_ORDER,	
				-- =============================	
				HEADER_PURCHASE_ORDER.*
				-- =============================	
	FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
	INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
	INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
	INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
	INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
	INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
	INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
	INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
				-- =============================
	WHERE		(	HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@VP_K_FOLIO
				OR	HEADER_PURCHASE_ORDER.CONFIRMING_ORDER_WITH				LIKE '%'+@PP_BUSCAR+'%'
				OR	D_VENDOR												LIKE '%'+@PP_BUSCAR+'%'
				OR	C_INFO_QUOTATION										LIKE '%'+@PP_BUSCAR+'%'
				OR	C_PURCHASE_ORDER										LIKE '%'+@PP_BUSCAR+'%'
				OR	HEADER_PURCHASE_ORDER.C_PURCHASE_ORDER					LIKE '%'+@PP_BUSCAR+'%' )
				-- =============================
	AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
	AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
				-- =============================
	AND			( @PP_K_STATUS_PURCHASE_ORDER	=-1		OR	HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=@PP_K_STATUS_PURCHASE_ORDER )
	AND			( @PP_K_VENDOR =-1			OR	HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
	AND			( @PP_K_CURRENCY =-1		OR	HEADER_PURCHASE_ORDER.K_CURRENCY=@PP_K_CURRENCY )
	AND			( @VP_K_APPROVED_BY =-1		OR	HEADER_PURCHASE_ORDER.K_APPROVED_BY=@VP_K_APPROVED_BY )
				-- =============================
	AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
	ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
END
ELSE	--- PARA MOSTRAR LOS REGISTROS QUE PUEDEN SER EDITADOS POR EL AREA DE FINANZAS.
BEGIN
	SET @VP_K_APPROVED_BY = -1

	SELECT		TOP (@VP_LI_N_REGISTROS)
				CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
				-- =============================	 
				F_DATE_PURCHASE_ORDER AS [DATE],
				F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
				F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
				F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
				-- =============================	 
				S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
				D_VENDOR,
				S_PLACED_BY	, D_PLACED_BY,
				S_TERMS		, D_TERMS	 ,				
				S_CURRENCY	, D_CURRENCY,
				D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
				-- =============================	
				(	CASE
					WHEN L_IS_BLANKET = 1 THEN 'SI'
					ELSE	'NO'
					END				)	AS SINO_BLANKET,
				-- =============================
				HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
				S_STATUS_PAID_ORDER,
				D_STATUS_PAID_ORDER,	
				-- =============================	
				HEADER_PURCHASE_ORDER.*
				-- =============================	
	FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
	INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
	INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
	INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
	INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
	INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
	INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
	INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
				-- =============================
	WHERE		(	HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@VP_K_FOLIO
				OR	HEADER_PURCHASE_ORDER.CONFIRMING_ORDER_WITH				LIKE '%'+@PP_BUSCAR+'%'
				OR	D_VENDOR												LIKE '%'+@PP_BUSCAR+'%'
				OR	C_INFO_QUOTATION										LIKE '%'+@PP_BUSCAR+'%'
				OR	C_PURCHASE_ORDER										LIKE '%'+@PP_BUSCAR+'%'
				OR	HEADER_PURCHASE_ORDER.C_PURCHASE_ORDER					LIKE '%'+@PP_BUSCAR+'%' )
				-- =============================
	AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
	AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
				-- =============================
	AND			( HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER IN (4,5,6,7,8,9,11) )
	AND			( @PP_K_VENDOR =-1			OR	HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
	AND			( @PP_K_CURRENCY =-1		OR	HEADER_PURCHASE_ORDER.K_CURRENCY=@PP_K_CURRENCY )
	AND			( @VP_K_APPROVED_BY =-1		OR	HEADER_PURCHASE_ORDER.K_APPROVED_BY=@VP_K_APPROVED_BY )
				-- =============================
	AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
	ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
END
	-- /////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / LISTADO
-- //	LISTADO PARA VERIFICAR LAS PO QUE SE DEBEN AUTORIZAR		--		LISTADO PARA GERENTES
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_LI_APPROVE_MANAGER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_LI_APPROVE_MANAGER]
GO
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,57,1		-- FABIOLA
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,47,0		-- MIKE
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,139,0		-- AX
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,41,0		-- RAFA
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,60,0		-- LIC. ADRIANA
--		 EXECUTE [dbo].[PG_LI_APPROVE_MANAGER] 0,60,1, -1,'2020-08-01' , '2020-11-10'		-- LIC. ADRIANA
CREATE PROCEDURE [dbo].[PG_LI_APPROVE_MANAGER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_L_PO_FINANCES				INT,
	-- ===========================	SE AGREGAN PARAMETROS PARA FILTROS DE LIC. ADRIANA DE LA REE
	@PP_K_STATUS_PURCHASE_ORDER		INT,
	@PP_F_INIT						DATE,
	@PP_F_FINISH					DATE,
	@PP_K_VENDOR					INT = -1
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	DECLARE @VP_LI_N_REGISTROS		INT =5000
	-- ///////////////////////////////////////////
	-- SE AGREGA PARA LAS AUTORIZACIONES POR PARTE DE FINANZAS CUANDO SON POR AUSCENCIA, AUTORIZA LA LIC. ADRIANA DE LA REE.
	IF @PP_K_USUARIO_ACCION NOT IN(60)
	BEGIN
		SET @PP_L_PO_FINANCES=0
	END
	-- ///////////////////////////////////////////	
	IF @PP_L_PO_FINANCES=0
	BEGIN
		-- =============================
		-- PARA LOS GERENTES QUE NO SON LA LIC ADRIANA SÓLO LE APARECERAN LAS PO PENDIENTES DE AUTORIZAR DE SU DEPARTAMENTO.
		IF @PP_K_USUARIO_ACCION NOT IN(60)
		BEGIN
			SELECT		TOP (@VP_LI_N_REGISTROS)
						(CASE
						WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
						ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
						END
						) AS RESTA_PAGAR,
						CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
						-- =============================	 
						F_DATE_PURCHASE_ORDER AS [DATE],
						F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
						F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
						F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
						-- =============================	 
						S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
						D_VENDOR,
						S_PLACED_BY	, D_PLACED_BY,
						S_TERMS		, D_TERMS	 ,				
						S_CURRENCY	, D_CURRENCY,
						D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
						-- =============================	
						(	CASE
							WHEN L_IS_BLANKET = 1 THEN 'SI'
							ELSE	'NO'
							END				)	AS SINO_BLANKET,
						-- =============================
						HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
						S_STATUS_PAID_ORDER,
						D_STATUS_PAID_ORDER,	
						-- =============================	
						HEADER_PURCHASE_ORDER.*
						-- =============================	
			FROM		HEADER_PURCHASE_ORDER	(NOLOCK) 
			INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK) ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
			INNER JOIN 	VENDOR					(NOLOCK) ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
			INNER JOIN 	PLACED_BY				(NOLOCK) ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
			INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK) ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
			INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK) ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
			INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK) ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
			INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	(NOLOCK) ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
			INNER JOIN	STATUS_PAID_ORDER		(NOLOCK) ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
						-- =============================
			WHERE		USUARIO_PEARL.K_USUARIO_PEARL=@PP_K_USUARIO_ACCION
						-- =============================
			AND			( HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	=	2 )
			AND			HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER<>7		-- ES LA PO QUE SE GENERÓ PARA PRUEBAS DE SISTEMAS.
			AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
						-- =============================
			AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
			ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
		END
		ELSE
		BEGIN
			-- ====================================================================================================================
			-- ====================================================================================================================
			--EXECUTE	[dbo].[PG_LI_APPROVE_FINANCES]	@PP_K_SISTEMA_EXE,	@PP_K_USUARIO_ACCION, @PP_K_STATUS_PURCHASE_ORDER,
			--										@PP_F_INIT,			@PP_F_FINISH

			IF @PP_K_STATUS_PURCHASE_ORDER=1
			-- PARA PODER VISUALIZAR TODOS LOS REGISTROS DE PO, INDEPENDIENTEMENTE EL ESTATUS EN EL QUE SE ENCUENTREN.
			-- ESTE MENÚ ES PARA COMPRAS
			BEGIN
				SELECT		TOP (@VP_LI_N_REGISTROS)
							CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
							(CASE
							WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
							ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
							END
							) AS RESTA_PAGAR,
							-- =============================	 
							F_DATE_PURCHASE_ORDER AS [DATE],
							F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
							F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
							F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
							-- =============================	 
							S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
							D_VENDOR,
							S_PLACED_BY	, D_PLACED_BY,
							S_TERMS		, D_TERMS	 ,				
							S_CURRENCY	, D_CURRENCY,
							D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
							-- =============================	
							(	CASE
								WHEN L_IS_BLANKET = 1 THEN 'SI'
								ELSE	'NO'
								END				)	AS SINO_BLANKET,
							-- =============================
							HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
							S_STATUS_PAID_ORDER,
							D_STATUS_PAID_ORDER,	
							-- =============================	
							HEADER_PURCHASE_ORDER.*
							-- =============================	
				FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
				INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
				INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
				INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
				INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
				INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
				INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
				INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	(NOLOCK) ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
				INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
							-- =============================
				WHERE		USUARIO_PEARL.K_USUARIO_PEARL=@PP_K_USUARIO_ACCION
							-- =============================
				AND			( HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	=	2 )
				AND			HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER<>7		-- ES LA PO QUE SE GENERÓ PARA PRUEBAS DE SISTEMAS.
				AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
							-- =============================
				AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
				ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
			END
			ELSE IF @PP_K_STATUS_PURCHASE_ORDER=2
			BEGIN
				-- PARA PODER VISUALIZAR TODOS LOS REGISTROS DE PO, INDEPENDIENTEMENTE EL ESTATUS EN EL QUE SE ENCUENTREN.
				-- ESTE MENÚ ES PARA PAGOS
					SELECT		TOP (@VP_LI_N_REGISTROS)
								(CASE
								WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
								ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
								END
								) AS RESTA_PAGAR,
								CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
								-- =============================	 
								F_DATE_PURCHASE_ORDER AS [DATE],
								F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
								F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
								F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
								-- =============================	
								S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
								D_VENDOR,
								S_PLACED_BY	, D_PLACED_BY,
								S_TERMS		, D_TERMS	 ,				
								S_CURRENCY	, D_CURRENCY,
								D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
								-- =============================	
								(	CASE
									WHEN L_IS_BLANKET = 1 THEN 'SI'
									ELSE	'NO'
									END				)	AS SINO_BLANKET,
								-- =============================
								HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
								S_STATUS_PAID_ORDER,
								D_STATUS_PAID_ORDER,	
								-- =============================		
								HEADER_PURCHASE_ORDER.*
								-- =============================	
					FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
					INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
					INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
					INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
					INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
					INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
					INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
					INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
--					INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
								-- =============================
					--WHERE		HEADER_PURCHASE_ORDER.K_APPROVED_BY=@PP_K_USUARIO_ACCION
					WHERE		@PP_K_USUARIO_ACCION IN (60)		-- (57,139)
								-- =============================
					AND			HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	IN	(14,12,16,17)
								-- =============================
					AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
					AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
					AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
								-- =============================
					AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
					--ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
					ORDER BY	O_STATUS_PURCHASE_ORDER, F_RECEIVED_PURCHASE_ORDER DESC
			END
			ELSE
			BEGIN
			-- PARA PODER VISUALIZAR LOS REGISTROS DE PO QUE TIENEN ACCIONES PENDIENTES POR EL AREA DE FINANZAS
				SELECT		TOP (@VP_LI_N_REGISTROS)
							(CASE
							WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
							ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
							END
							) AS RESTA_PAGAR,
							CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
							-- =============================	 
							F_DATE_PURCHASE_ORDER AS [DATE],
							F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
							F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
							F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
							-- =============================	
							S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
							D_VENDOR,
							S_PLACED_BY	, D_PLACED_BY,
							S_TERMS		, D_TERMS	 ,				
							S_CURRENCY	, D_CURRENCY,
							D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
							-- =============================	
							(	CASE
								WHEN L_IS_BLANKET = 1 THEN 'SI'
								ELSE	'NO'
								END				)	AS SINO_BLANKET,
							-- =============================
							HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
							S_STATUS_PAID_ORDER,
							D_STATUS_PAID_ORDER,	
							-- =============================	
							HEADER_PURCHASE_ORDER.*
							-- =============================	
				FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
				INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
				INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
				INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
				INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
				INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
				INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
				INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
--				INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
							-- =============================
				--WHERE		HEADER_PURCHASE_ORDER.K_APPROVED_BY=@PP_K_USUARIO_ACCION
				WHERE		@PP_K_USUARIO_ACCION IN	(60)	---(57,139)
							-- =============================
				AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
							-- =============================
				AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
				AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
							-- =============================
				--AND			HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=@PP_K_STATUS_PURCHASE_ORDER
				AND			( @PP_K_STATUS_PURCHASE_ORDER=-1	 OR		HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=@PP_K_STATUS_PURCHASE_ORDER )
				AND			( HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	<>	2 )
							-- =============================
				AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
				--ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
				ORDER BY	O_STATUS_PURCHASE_ORDER, F_RECEIVED_PURCHASE_ORDER DESC
			END

			-- ====================================================================================================================
			-- ====================================================================================================================
		END
	END
	-- =============================
	-- ESTE IF ES CUANDO SE TIENE MARCADA LA OPCIÓN DE VER LAS PO DE OTROS DEPARTAMENTOS PENDIENTES DE AUTORIZAR POR GENERENCIA DE DEPARTAMENTO
	-- SÓLO LA LIC ADRIANA TIENE PERMISOS PARA REALIZAR ESTAACCIÓN.
	ELSE IF @PP_L_PO_FINANCES=1
	BEGIN
		SELECT		TOP (@VP_LI_N_REGISTROS)
					(CASE
					WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
					ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
					END
					) AS RESTA_PAGAR,
					CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
					--F_DATE_PURCHASE_ORDER AS [DATE],
					--F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
					-- =============================	 
					F_DATE_PURCHASE_ORDER AS [DATE],
					F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
					F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
					F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
					-- =============================	 
					S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
					D_VENDOR,
					S_PLACED_BY	, D_PLACED_BY,
					S_TERMS		, D_TERMS	 ,				
					S_CURRENCY	, D_CURRENCY,
					D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
					-- =============================	
					(	CASE
						WHEN L_IS_BLANKET = 1 THEN 'SI'
						ELSE	'NO'
						END				)	AS SINO_BLANKET,
					-- =============================
					HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
					S_STATUS_PAID_ORDER,
					D_STATUS_PAID_ORDER,	
					-- =============================	
					HEADER_PURCHASE_ORDER.*
					-- =============================	
		FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
		INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
		INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
		INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
		INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
		INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
		INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
		INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	(NOLOCK)	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
		INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
					-- =============================
		--WHERE		USUARIO_PEARL.K_USUARIO_PEARL=@PP_K_USUARIO_ACCION
					-- =============================
		WHERE		HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	IN	(2,7)
		AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
					-- =============================
		AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
		ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC			
	END
	-- /////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / LISTADO						--		
-- //	LISTADO PARA VERIFICAR LAS PO QUE SE DEBEN AUTORIZAR		--		LISTADO PARA FINANZAS
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_LI_APPROVE_FINANCES]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_LI_APPROVE_FINANCES]
GO															
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,139,1,'2020-08-08' , '2020-09-10'		11		-- FABIOLA
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,69,1,'2020-08-08' , '2020-09-10'		11		-- MARIAS
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,157,1,'2020-08-08' , '2020-09-10'		11		-- BERENICES
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,47		2		-- MIKE
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,139,		-1		-- AX
--		 EXECUTE [dbo].[PG_LI_APPROVE_FINANCES] 0,60		2		-- LIC. ADRIANA
CREATE PROCEDURE [dbo].[PG_LI_APPROVE_FINANCES]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_STATUS_PURCHASE_ORDER		INT,
	@PP_F_INIT						DATE,
	@PP_F_FINISH					DATE,
	@PP_K_VENDOR					INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	DECLARE @VP_LI_N_REGISTROS		INT =5000
	-- ///////////////////////////////////////////	

	IF @PP_K_STATUS_PURCHASE_ORDER=1
	-- PARA PODER VISUALIZAR TODOS LOS REGISTROS DE PO, INDEPENDIENTEMENTE EL ESTATUS EN EL QUE SE ENCUENTREN.
	-- ESTE MENÚ ES PARA COMPRAS
	BEGIN
		SELECT		TOP (@VP_LI_N_REGISTROS)
					(CASE
					WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
					ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
					END
					) AS RESTA_PAGAR,
					CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
					-- =============================	 
					F_DATE_PURCHASE_ORDER AS [DATE],
					F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
					F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
					F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
					-- =============================	
					S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
					D_VENDOR,
					S_PLACED_BY	, D_PLACED_BY,
					S_TERMS		, D_TERMS	 ,				
					S_CURRENCY	, D_CURRENCY,
					D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
					-- =============================	
					(	CASE
						WHEN L_IS_BLANKET = 1 THEN 'SI'
						ELSE	'NO'
						END				)	AS SINO_BLANKET,
					-- =============================
					HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
					S_STATUS_PAID_ORDER,
					D_STATUS_PAID_ORDER,	
					-- =============================	
					HEADER_PURCHASE_ORDER.*
					-- =============================	
		FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
		INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
		INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
		INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
		INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
		INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
		INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
		INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
--		INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
					-- =============================
		--WHERE		HEADER_PURCHASE_ORDER.K_APPROVED_BY=@PP_K_USUARIO_ACCION
		WHERE		@PP_K_USUARIO_ACCION IN (57,139,69,157,161)		-- (57,139)
					-- =============================
		AND			HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	IN	(4,6,7,9,11,13)		-- (4,6,7,9,11)
		AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
					-- =============================
		AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
		AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
					-- =============================
		AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
		--ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
		ORDER BY	O_STATUS_PURCHASE_ORDER, F_RECEIVED_PURCHASE_ORDER DESC		
	END
	ELSE IF @PP_K_STATUS_PURCHASE_ORDER=2
	BEGIN
		-- PARA PODER VISUALIZAR TODOS LOS REGISTROS DE PO, INDEPENDIENTEMENTE EL ESTATUS EN EL QUE SE ENCUENTREN.
		-- ESTE MENÚ ES PARA PAGOS
			SELECT		TOP (@VP_LI_N_REGISTROS)
						(CASE
						WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
						ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
						END
						) AS RESTA_PAGAR,
						CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
						-- =============================	 
						F_DATE_PURCHASE_ORDER AS [DATE],
						F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
						F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
						F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
						-- =============================	
						S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
						D_VENDOR,
						S_PLACED_BY	, D_PLACED_BY,
						S_TERMS		, D_TERMS	 ,				
						S_CURRENCY	, D_CURRENCY,
						D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
						-- =============================	
						(	CASE
							WHEN L_IS_BLANKET = 1 THEN 'SI'
							ELSE	'NO'
							END				)	AS SINO_BLANKET,
						-- =============================
						HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
						S_STATUS_PAID_ORDER,
						D_STATUS_PAID_ORDER,	
						-- =============================		
						HEADER_PURCHASE_ORDER.*
						-- =============================	
			FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
			INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
			INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
			INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
			INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
			INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
			INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
			INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
--			INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
						-- =============================
			--WHERE		HEADER_PURCHASE_ORDER.K_APPROVED_BY=@PP_K_USUARIO_ACCION
			WHERE		@PP_K_USUARIO_ACCION IN (57,139,69,157,161)		-- (57,139)
						-- =============================
			AND			HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER	IN	(14,12,16,17)
			AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
						-- =============================
			AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
			AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
						-- =============================
			AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
			--ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
			ORDER BY	O_STATUS_PURCHASE_ORDER, F_RECEIVED_PURCHASE_ORDER DESC
	END
	ELSE
	BEGIN
	-- PARA PODER VISUALIZAR LOS REGISTROS DE PO QUE TIENEN ACCIONES PENDIENTES POR EL AREA DE FINANZAS
		SELECT		TOP (@VP_LI_N_REGISTROS)
					(CASE
					WHEN	TOTAL_PURCHASE_ORDER_CLOSED	<>	0	THEN	TOTAL_PURCHASE_ORDER_CLOSED-PREPAID_PURCHASE_ORDER
					ELSE	TOTAL_PURCHASE_ORDER-PREPAID_PURCHASE_ORDER
					END
					) AS RESTA_PAGAR,
					CONVERT(DECIMAL(10,2),(TAX_RATE*100)) AS TAX,
					-- =============================	 
					F_DATE_PURCHASE_ORDER AS [DATE],
					F_REQUIRED_PURCHASE_ORDER AS [REQUIRED],
					F_PROMISE_PURCHASE_ORDER AS  [PROMISE],
					F_RECEIVED_PURCHASE_ORDER AS [RECEIVED],
					-- =============================	
					S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
					D_VENDOR,
					S_PLACED_BY	, D_PLACED_BY,
					S_TERMS		, D_TERMS	 ,				
					S_CURRENCY	, D_CURRENCY,
					D_DELIVERY_PURCHASE_ORDER AS D_DELIVERY_TO,
					-- =============================	
					(	CASE
						WHEN L_IS_BLANKET = 1 THEN 'SI'
						ELSE	'NO'
						END				)	AS SINO_BLANKET,
					-- =============================
					HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER,
					S_STATUS_PAID_ORDER,
					D_STATUS_PAID_ORDER,	
					-- =============================	
					HEADER_PURCHASE_ORDER.*
					-- =============================	
		FROM		HEADER_PURCHASE_ORDER	(NOLOCK)	
		INNER JOIN 	STATUS_PURCHASE_ORDER	(NOLOCK)	ON STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
		INNER JOIN 	VENDOR					(NOLOCK)	ON VENDOR.K_VENDOR=HEADER_PURCHASE_ORDER.K_VENDOR
		INNER JOIN 	PLACED_BY				(NOLOCK)	ON PLACED_BY.K_PLACED_BY=HEADER_PURCHASE_ORDER.K_PLACED_BY
		INNER JOIN	DELIVERY_PURCHASE_ORDER (NOLOCK)	ON DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER=HEADER_PURCHASE_ORDER.K_DELIVERY_TO
		INNER JOIN 	BD_GENERAL.DBO.TERMS	(NOLOCK)	ON TERMS.K_TERMS=HEADER_PURCHASE_ORDER.K_TERMS
		INNER JOIN 	BD_GENERAL.DBO.CURRENCY	(NOLOCK)	ON CURRENCY.K_CURRENCY=HEADER_PURCHASE_ORDER.K_CURRENCY
		INNER JOIN	STATUS_PAID_ORDER		(NOLOCK)	ON STATUS_PAID_ORDER.K_STATUS_PAID_ORDER=HEADER_PURCHASE_ORDER.K_STATUS_PAID_ORDER
--		INNER JOIN	BD_GENERAL.dbo.USUARIO_PEARL	ON HEADER_PURCHASE_ORDER.K_APPROVED_BY=USUARIO_PEARL.K_EMPLEADO_PEARL
					-- =============================
		--WHERE		HEADER_PURCHASE_ORDER.K_APPROVED_BY=@PP_K_USUARIO_ACCION
		WHERE		@PP_K_USUARIO_ACCION IN	(57,139,69,157,161)	---(57,139)
					-- =============================
		AND			( @PP_K_VENDOR	=-1			OR		HEADER_PURCHASE_ORDER.K_VENDOR=@PP_K_VENDOR )
					-- =============================
		AND			( @PP_F_INIT IS NULL		OR	@PP_F_INIT<=F_DATE_PURCHASE_ORDER)
		AND			( @PP_F_FINISH IS NULL		OR	@PP_F_FINISH>=F_DATE_PURCHASE_ORDER)
					-- =============================
		--AND			HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=@PP_K_STATUS_PURCHASE_ORDER
		AND			( @PP_K_STATUS_PURCHASE_ORDER=-1	 OR		HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=@PP_K_STATUS_PURCHASE_ORDER )
					-- =============================
		AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
		--ORDER BY	K_STATUS_PURCHASE_ORDER, F_DATE_PURCHASE_ORDER	DESC
		ORDER BY	O_STATUS_PURCHASE_ORDER, F_RECEIVED_PURCHASE_ORDER DESC
	END
	-- /////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_HEADER_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_HEADER_PURCHASE_ORDER]
GO
-- EXECUTE [dbo].[PG_SK_HEADER_PURCHASE_ORDER] 0,139,536,0
-- EXECUTE [dbo].[PG_SK_DETAILS_PURCHASE_ORDER] 0,139,22,0
CREATE PROCEDURE [dbo].[PG_SK_HEADER_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPO					INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''	
	-- ///////////////////////////////////////////			
	SELECT		TOP (1)
				-- ===========================	-- ===========================
				FORMAT(HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER,'000000') AS NUMBER_PO,
				-- PARA BLANKET PO
				L_IS_BLANKET					AS L_IS_BLANKET_PO,
				ISNULL(K_CUSTOMER,0)			AS K_CUSTOMER,
				ISNULL(D_PROGRAM,'')			AS D_PROGRAM			,
				ISNULL(ANNUAL_VOLUME,0)			AS ANNUAL_VOLUME		,
				ISNULL(GROSS_VEHICLE_AREA,0)	AS GROSS_VEHICLE_AREA	,
				-- ===========================	-- ===========================
				S_STATUS_PURCHASE_ORDER	, D_STATUS_PURCHASE_ORDER,
				D_VENDOR,
				S_PLACED_BY	, D_PLACED_BY,
				S_CURRENCY	, D_CURRENCY,	
				S_TERMS		, D_TERMS	 , C_TERMS	 ,
				-- ===========================	-- ===========================				
				--(CASE	
				--	WHEN	HEADER_PURCHASE_ORDER.K_TERMS=2 
				--	AND		(VENDOR.N_CREDIT_DAYS>0 
				--			--OR VENDOR.N_CREDIT_DAYS<>'') THEN	CONVERT(VARCHAR(5),VENDOR.[N_CREDIT_DAYS]) +' Día(s)/Day(s)'	-- ASI IBA A SER PARA NORMAL PERO NO FUNCIONA
				--			OR VENDOR.N_CREDIT_DAYS<>'') THEN	'NET ' + CONVERT(VARCHAR(5),VENDOR.[N_CREDIT_DAYS]) +' Days'	-- ASI LO QUIERE OMAR
				--	ELSE	''
				--END	) AS CREDIT_DAYS,
				-- ===========================	-- ===========================				
				(CASE	
					WHEN K_DELIVERY_TO IN (3) THEN	D_DELIVERY_TO
					ELSE	D_DELIVERY_PURCHASE_ORDER 
				END	) AS D_DELIVERY_TO,							
				-- ===========================	-- ===========================
				--D_DELIVERY_PURCHASE_ORDER	AS D_DELIVERY_TO,
				C_DELIVERY_PURCHASE_ORDER	AS C_DELIVERY_TO,
				S_DELIVERY_PURCHASE_ORDER	AS S_DELIVERY_TO,
				CONVERT(DECIMAL(10,2),TAX_RATE*100) AS TAX_RATE_PER,
				-- ===========================	-- ===========================
				CONVERT(VARCHAR, CAST(SUBTOTAL_PURCHASE_ORDER AS MONEY), 2)	AS SUBTOTAL_PURCHASE_ORDER,
				--CAST(ADDITIONAL_TAXES_PURCHASE_ORDER AS MONEY)			AS OTHER_CHARGES_PURCHASE_ORDER,
				--CAST(ADDITIONAL_DISCOUNTS_PURCHASE_ORDER AS MONEY)		AS DISCOUNTS_PURCHASE_ORDER,
				CONVERT(VARCHAR, CAST(IVA_PURCHASE_ORDER AS MONEY), 2)		AS IVA_PURCHASE_ORDER,
				CONVERT(VARCHAR, CAST(TOTAL_PURCHASE_ORDER AS MONEY), 2)	AS TOTAL_PURCHASE_ORDER,
				-- ===========================	-- ===========================
				-- ===========================	-- ===========================
				-- ===========================	-- ===========================
				---- PARA INSERTAR LOS NOMBRES DE LAS AUTORIZACIONES/APROBACIONES Y QUIEN GENERA.
				CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) AS APPROVED,
				---- PARA OBTENER LA RUTA DEL ARCHIVO DE LA FIRMA DIGITAL DEL GERENTE
				CONCAT(C_FIRMAS,D_FIRMAS,S_FIRMAS)	AS RUTA_FIRMA,
				-- ===========================	-- ===========================
				-- ===========================	-- ===========================
				-- ===========================	-- ===========================
				--(CASE	
				--	WHEN CAST(F_REQUIRED_PURCHASE_ORDER AS DATE)=CAST(F_DATE_PURCHASE_ORDER AS DATE) THEN	'ASAP'
				--	ELSE	F_REQUIRED_PURCHASE_ORDER 
				--END	) AS ASAP,
				HEADER_PURCHASE_ORDER.*
				-- =============================	
	FROM		HEADER_PURCHASE_ORDER	(NOLOCK),		STATUS_PURCHASE_ORDER	(NOLOCK), 
				VENDOR	(NOLOCK),						PLACED_BY	(NOLOCK),
				BD_GENERAL.DBO.TERMS	(NOLOCK),		BD_GENERAL.DBO.CURRENCY	(NOLOCK),
				DELIVERY_PURCHASE_ORDER	(NOLOCK),
				-- =============================
				-- =============================
				HOWE.DBO.VISTA_GAFETES,				-- PARA OBTENER EL NOMBRE DE LA PERSONA QUE AUTORIZARÁ LA PO
				BD_GENERAL.DBO.FIRMAS
				-- =============================
	LEFT JOIN	DETAILS_BLANKET_PURCHASE_ORDER		ON DETAILS_BLANKET_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=K_HEADER_PURCHASE_ORDER
	AND			DETAILS_BLANKET_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND			DETAILS_BLANKET_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
				-- =============================
	WHERE		HEADER_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER=STATUS_PURCHASE_ORDER.K_STATUS_PURCHASE_ORDER
	AND			HEADER_PURCHASE_ORDER.K_VENDOR=VENDOR.K_VENDOR
	AND			HEADER_PURCHASE_ORDER.K_PLACED_BY=PLACED_BY.K_PLACED_BY
	AND			HEADER_PURCHASE_ORDER.K_TERMS=TERMS.K_TERMS
	AND			HEADER_PURCHASE_ORDER.K_DELIVERY_TO=DELIVERY_PURCHASE_ORDER.K_DELIVERY_PURCHASE_ORDER
	AND			HEADER_PURCHASE_ORDER.K_CURRENCY=CURRENCY.K_CURRENCY
				-- =============================
				-- =============================
	AND			EN_NUM_EMP=HEADER_PURCHASE_ORDER.K_APPROVED_BY
	AND			HEADER_PURCHASE_ORDER.K_APPROVED_BY=FIRMAS.K_FIRMAS
				-- =============================
--	AND			DETAILS_BLANKET_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
				-- =============================
	AND			HEADER_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND			HEADER_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
	AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1		
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_DETAILS_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_DETAILS_PURCHASE_ORDER]
GO
--	EXECUTE [dbo].[PG_SK_HEADER_PURCHASE_ORDER] 0,139,536,0
--	EXECUTE [dbo].[PG_SK_DETAILS_PURCHASE_ORDER] 0,139,240,0
CREATE PROCEDURE [dbo].[PG_SK_DETAILS_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPO					INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	DECLARE @VP_K_STATUS			INT
	-- ///////////////////////////////////////////
	SELECT		@VP_K_STATUS = K_STATUS_PURCHASE_ORDER
	FROM		HEADER_PURCHASE_ORDER	(NOLOCK)
	WHERE		K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND			K_PO_TEMPORAL=@PP_K_PO_TEMPO
	
	IF	@VP_K_STATUS IN (11)
	BEGIN
		SELECT		TOP (5000)
					K_PO_PRICE_LOG	AS K_PO_PRICE,
					S_CURRENCY,
					ITEM.K_CURRENCY,
					S_UNIT_OF_MEASURE,
					PART_NUMBER_ITEM_VENDOR,
					D_ITEM,
					-- ======================================================
					DETAILS_PURCHASE_ORDER.QUANTITY_ORDER		AS QUANTITY,					
					DETAILS_PURCHASE_ORDER.QUANTITY_ORDER		AS QUANTITY_RECEIVED,
					0											AS QUANTITY_PENDING,
					DETAILS_PURCHASE_ORDER.QUANTITY_PENDING		AS QUANTITY_PENDING_ORIGINAL,
					-- ======================================================
					DETAILS_PURCHASE_ORDER.UNIT_PRICE AS PRICE_ITEM, --PRICE_ITEM,
					TOTAL_PRICE as TOTAL_ITEM,
					DETAILS_PURCHASE_ORDER.*
		FROM		DETAILS_PURCHASE_ORDER			(NOLOCK)
		INNER JOIN	ITEM							(NOLOCK)	ON	DETAILS_PURCHASE_ORDER.K_ITEM=ITEM.K_ITEM
		INNER JOIN	BD_GENERAL.DBO.UNIT_OF_MEASURE	(NOLOCK)	ON ITEM.K_UNIT_OF_ITEM=UNIT_OF_MEASURE.K_UNIT_OF_MEASURE
		INNER JOIN	BD_GENERAL.DBO.CURRENCY			(NOLOCK)	ON	ITEM.K_CURRENCY=CURRENCY.K_CURRENCY
		WHERE		DETAILS_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND			DETAILS_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
		ORDER BY	K_DETAILS_PURCHASE_ORDER
	END
	ELSE IF	@VP_K_STATUS IN (13)
	BEGIN
		SELECT		TOP (5000)
					K_PO_PRICE_LOG	AS K_PO_PRICE,
					S_CURRENCY,
					ITEM.K_CURRENCY,
					S_UNIT_OF_MEASURE,
					PART_NUMBER_ITEM_VENDOR,
					D_ITEM,
					-- ======================================================
					DETAILS_PURCHASE_ORDER.QUANTITY_ORDER		AS QUANTITY,
					0											AS QUANTITY_RECEIVED,
					(DETAILS_PURCHASE_ORDER.QUANTITY_ORDER - DETAILS_PURCHASE_ORDER.QUANTITY_RECEIVED)		AS QUANTITY_PENDING,
					DETAILS_PURCHASE_ORDER.QUANTITY_RECEIVED	AS QUANTITY_PENDING_ORIGINAL,
					-- ======================================================
					DETAILS_PURCHASE_ORDER.UNIT_PRICE AS PRICE_ITEM, --PRICE_ITEM,
					TOTAL_PRICE as TOTAL_ITEM,
					DETAILS_PURCHASE_ORDER.*
		FROM		DETAILS_PURCHASE_ORDER			(NOLOCK)
		INNER JOIN	ITEM							(NOLOCK)	ON	DETAILS_PURCHASE_ORDER.K_ITEM=ITEM.K_ITEM
		INNER JOIN	BD_GENERAL.DBO.UNIT_OF_MEASURE	(NOLOCK)	ON ITEM.K_UNIT_OF_ITEM=UNIT_OF_MEASURE.K_UNIT_OF_MEASURE
		INNER JOIN	BD_GENERAL.DBO.CURRENCY			(NOLOCK)	ON	ITEM.K_CURRENCY=CURRENCY.K_CURRENCY
		WHERE		DETAILS_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND			DETAILS_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
		ORDER BY	K_DETAILS_PURCHASE_ORDER
--		AND			DETAILS_PURCHASE_ORDER.QUANTITY_RECEIVED<>0
	END
	ELSE
	BEGIN
		SELECT		TOP (5000)
					K_PO_PRICE_LOG	AS K_PO_PRICE,
					S_CURRENCY,
					ITEM.K_CURRENCY,
					S_UNIT_OF_MEASURE,
					PART_NUMBER_ITEM_VENDOR,
					D_ITEM,
					DETAILS_PURCHASE_ORDER.QUANTITY_ORDER	AS QUANTITY,
					DETAILS_PURCHASE_ORDER.QUANTITY_ORDER	AS QUANTITY_PENDING_ORIGINAL,
					DETAILS_PURCHASE_ORDER.UNIT_PRICE AS PRICE_ITEM, --PRICE_ITEM,
					TOTAL_PRICE as TOTAL_ITEM,
					DETAILS_PURCHASE_ORDER.*
		FROM		DETAILS_PURCHASE_ORDER			(NOLOCK)
		INNER JOIN	ITEM							(NOLOCK)	ON	DETAILS_PURCHASE_ORDER.K_ITEM=ITEM.K_ITEM
		INNER JOIN	BD_GENERAL.DBO.UNIT_OF_MEASURE	(NOLOCK)	ON ITEM.K_UNIT_OF_ITEM=UNIT_OF_MEASURE.K_UNIT_OF_MEASURE
		INNER JOIN	BD_GENERAL.DBO.CURRENCY			(NOLOCK)	ON	ITEM.K_CURRENCY=CURRENCY.K_CURRENCY
		WHERE		DETAILS_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND			DETAILS_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
		ORDER BY	K_DETAILS_PURCHASE_ORDER
	END
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / FICHA
-- // OBTIENE EL LOG DE RECEPCIÓN DE MATERIAL DE PO'S
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_DETAILS_LOG]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_DETAILS_LOG]
GO
-- EXECUTE	[PG_SK_DETAILS_LOG] 0,139,  528,0
-- EXECUTE	[PG_SK_DETAILS_LOG] 0,139,  418,0
CREATE PROCEDURE [dbo].[PG_SK_DETAILS_LOG]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPO					INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	DECLARE @VP_K_STATUS			INT
	-- ///////////////////////////////////////////
		SELECT		TOP (5000)
					K_LOG_DETAILS_PURCHASE_ORDER
					,LOG_DETAILS_PURCHASE_ORDER.K_ITEM
					,S_CURRENCY
					,ITEM.K_CURRENCY
					,S_UNIT_OF_MEASURE
					,PART_NUMBER_ITEM_VENDOR
					,LOG_DETAILS_PURCHASE_ORDER.F_ALTA
					,D_ITEM
					,[QUANTITY_ORDER]
					,[QUANTITY_RECEIVED]
					,[QUANTITY_PENDING]
					,[QUANTITY_PENDING_ORIGINAL]
		FROM		LOG_DETAILS_PURCHASE_ORDER		(NOLOCK)
		INNER JOIN	ITEM							(NOLOCK)	ON	LOG_DETAILS_PURCHASE_ORDER.K_ITEM=ITEM.K_ITEM
		INNER JOIN	BD_GENERAL.DBO.UNIT_OF_MEASURE	(NOLOCK)	ON ITEM.K_UNIT_OF_ITEM=UNIT_OF_MEASURE.K_UNIT_OF_MEASURE
		INNER JOIN	BD_GENERAL.DBO.CURRENCY			(NOLOCK)	ON	ITEM.K_CURRENCY=CURRENCY.K_CURRENCY
		WHERE		LOG_DETAILS_PURCHASE_ORDER.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND			LOG_DETAILS_PURCHASE_ORDER.K_PO_TEMPORAL=@PP_K_PO_TEMPO
		AND			QUANTITY_RECEIVED<>0
		ORDER BY	K_LOG_DETAILS_PURCHASE_ORDER	,	LOG_DETAILS_PURCHASE_ORDER.F_ALTA DESC
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
--EN_NUM_DEPT		DP_DESC_DEPTO					--EN_NUM_DEPT		DP_DESC_DEPTO
	--1				DEPTO 1    (ADMINISTRACION)			--2				DEPTO 2 (PRODUCCION)
	--3				DEPTO 3 (MATERIALES)				--4				DEPTO 4  (CONTROL DE CALIDAD)
	--5				INGENIERIA-MANTENIMIENTO			--6				PRODUCCION
	--7				SISTEMAS							--8				FINANZAS
	--9				GERENCIA							--10			NO EXISTE EL 10
	--11			PERFORACION							--12			INGENIERIA DE PROYECTOS
	
	-- (1)			THEN	(7945)			-- RH					PATRICIACH
	-- (2,6,11)		THEN	(22)			-- PRODUCCION			GUILLERMOM
	-- (5)			THEN	(11928)			-- MANTENIMIENTO		OMARG	(156)
	-- (3)			THEN	(4475)			-- MATERIALES			MANUELG
	-- (4)			THEN	(1299)			-- CALIDAD				MIGUELC
	-- (12)			THEN	(181)			-- PROYECTOS			OMARD
	-- (7)			THEN	(6142)			-- SISTEMAS				RAFAELF	(41)
	-- (8)			THEN	(67)			-- FINANZAS				ADRIANAD
	-- (9)			THEN	(52)			-- GERENTE				JORGEH	
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_ISSUED]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_ISSUED]
GO
-- EXECUTE [dbo].[PG_SK_ISSUED] 0,139,139
-- EXECUTE [dbo].[PG_SK_ISSUED] 0,139,145
-- EXECUTE [dbo].[PG_SK_ISSUED] 0,139,42
CREATE PROCEDURE [dbo].[PG_SK_ISSUED]
	@PP_K_SISTEMA_EXE			INT,
	@PP_K_USUARIO_ACCION		INT,
	-- ===========================
	@PP_K_USUARIO				INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''	
	-- ///////////////////////////////////////////			
	SELECT	TOP (1)
			USUARIO_PEARL.K_USUARIO_PEARL AS K_USUARIO_ALTA,
			CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) AS ISSUED,
			(	CASE
					WHEN	EN_NUM_DEPT IN (1)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=1 AND 	EN_SUPERVISOR='GERENTES' AND EN_NUM_EMP=7945)	-- RH					
					WHEN	EN_NUM_DEPT IN (2,5,6,11)	THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=6 AND 	EN_SUPERVISOR='GERENTES')						-- PRODUCCION
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (2,6,11)		THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=6 AND 	EN_SUPERVISOR='GERENTES')						-- PRODUCCION
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (5)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=5 AND 	EN_SUPERVISOR='GERENTES')						-- MANTENIMIENTO
					WHEN	EN_NUM_DEPT IN (3)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=3 AND 	EN_SUPERVISOR='GERENTES')						-- MATERIALES
					WHEN	EN_NUM_DEPT IN (4)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=4 AND 	EN_SUPERVISOR='GERENTES')						-- CALIDAD
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (7,12)		THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=12 AND EN_SUPERVISOR='GERENTES')					-- PROYECTOS / SISTEMAS
					WHEN	EN_NUM_DEPT IN (12)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=12 AND EN_SUPERVISOR='GERENTES')					-- PROYECTOS	-- CAMBIO_FIRMA		--
					WHEN	EN_NUM_DEPT IN (7)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=7 AND PT_PUESTO_TRABAJO='GSI')					-- SISTEMAS		-- CAMBIO_FIRMA		--
					WHEN	EN_NUM_DEPT IN (8)			THEN	(SELECT CONCAT(EP_NOMBRE,' ',EP_APELLIDO_PATERNO) FROM	HOWE.DBO.VISTA_GAFETES (NOLOCK)	WHERE EN_NUM_DEPT=8 AND 	EN_SUPERVISOR='GERENTES')						-- FINANZAS
					WHEN	EN_NUM_DEPT IN (9)			THEN	'JORGE HOLGUIN'
					ELSE	'X'
			END )		APPROVED,
				--SE OBTIENE LA K_DEL GERENTE PARA OBTENER LA IMAGEN EN EL REPORTE DE LA PO
			(	CASE
					WHEN	EN_NUM_DEPT IN (1)			THEN	(7945)			-- RH					
					WHEN	EN_NUM_DEPT IN (2,5,6,11)	THEN	(22)			-- PRODUCCION
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (2,6,11)		THEN	(22)			-- PRODUCCION
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (5)			THEN	(11928)			-- MANTENIMIENTO
					WHEN	EN_NUM_DEPT IN (3)			THEN	(4475)			-- MATERIALES
					WHEN	EN_NUM_DEPT IN (4)			THEN	(1299)			-- CALIDAD
-- CAMBIO_FIRMA		--WHEN	EN_NUM_DEPT IN (7,12)		THEN	(181)			-- PROYECTOS / SISTEMAS
					WHEN	EN_NUM_DEPT IN (12)			THEN	(181)			-- PROYECTOS	-- CAMBIO_FIRMA		--
					WHEN	EN_NUM_DEPT IN (7)			THEN	(6142)			-- SISTEMAS		-- CAMBIO_FIRMA		--
					WHEN	EN_NUM_DEPT IN (8)			THEN	(67)			-- FINANZAS
					WHEN	EN_NUM_DEPT IN (9)			THEN	'JORGE HOLGUIN'
					ELSE	'X'
			END )		K_APPROVED,
			'JORGE HOLGUIN' AS AUTHORIZED
	FROM    BD_GENERAL.DBO.USUARIO_PEARL	(NOLOCK)
	LEFT JOIN HOWE.DBO.VISTA_GAFETES		(NOLOCK)	ON EN_NUM_EMP=K_EMPLEADO_PEARL
	WHERE	L_BORRADO=0
	AND		USUARIO_PEARL.K_USUARIO_PEARL=@PP_K_USUARIO
	ORDER BY APELLIDO_PATERNO ASC
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- //	STORED PROCEDURE ---> REVIEW_ESTATUS		
-- //	CONSULTA LOS PERMISOS PARA SABER SI PUEDE ABRIR O 
-- //	EJECUTAR CIERTA ACCIÓN EN LA FORMA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_PERMISOS_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_PERMISOS_PO]
GO
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,57,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,60,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,69,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,157,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,62,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,139,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,145,6002
--		 EXECUTE [dbo].[PG_SK_PERMISOS_PO] 0,41,6002
CREATE PROCEDURE [dbo].[PG_SK_PERMISOS_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_GRUPO_APROBADOR			INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''	
	-- ///////////////////////////////////////////		
	SELECT		TOP (1)
				COUNT(K_USUARIO)	AS MENSAJE
				-- =============================	
	FROM		BD_GENERAL.DBO.GRUPO_APROBADOR	(NOLOCK)
				-- =============================
	WHERE		K_USUARIO=@PP_K_USUARIO_ACCION
	AND			K_TIPO_GRUPO_APROBADOR=@PP_K_GRUPO_APROBADOR
	AND			K_ESTATUS_GRUPO_APROBADOR=1
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- //	STORED PROCEDURE ---> VERIFICAR ESTATUS A REVISAR
-- //	CONSULTA EN BASE AL USUARIO A QUE PO PODRÁ CAMBIAR EL ESTATUS
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_VERIFICAR_ESTATUS_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO]
GO
--		 EXECUTE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO] 0,62
--		 EXECUTE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO] 0,139
--		 EXECUTE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO] 0,145
--		 EXECUTE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO] 0,60,1
CREATE PROCEDURE [dbo].[PG_SK_VERIFICAR_ESTATUS_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_L_PO_FINANCES				INT,
	-- ===========================
	@PP_K_STATUS					INT,
	@PP_F_INIT						DATE,
	@PP_F_FINISH					DATE,
	@PP_K_VENDOR					INT = -1
--	@OU_K_ESTATUS					INT		OUTPUT
AS
	DECLARE @VP_K_ESTATUS_A_REVISAR			INT=0
	DECLARE @VP_SP_EJECUTAR					VARCHAR(150)=''
	-- ///////////////////////////////////////////		
	--	DEPTO		#EMPLEADO PEARL	DESC_DEPTO				D_USUARIO		#USUARIO_PEARL
	-- (1)			(7945)			-- RH					PATRICIACH		62
	-- (2,6,11)		(22)			-- PRODUCCION			GUILLERMOM		44
	-- (5)			(11928)			-- MANTENIMIENTO		OMARG			156
	-- (3)			(4475)			-- MATERIALES			MANUELG			56
	-- (4)			(1299)			-- CALIDAD				MIGUELC			47
	-- (12)			(181)			-- PROYECTOS			OMARD			42
	-- (7)			(6142)			-- SISTEMAS				RAFAELF			41
	-- (8)			(67)			-- FINANZAS				ADRIANAD		60
	-- (9)			(52)			-- GERENTE				JORGEH			43

--	IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43)			SIN OMAR Y RAFA
-- CAMBIO_FIRMA		--IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43,44,156)	CON OMAR Y RAFA
	IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43,41)		-- -SIN OMAR
		BEGIN
			EXECUTE	[dbo].[PG_LI_APPROVE_MANAGER]	@PP_K_SISTEMA_EXE,	@PP_K_USUARIO_ACCION,	@PP_L_PO_FINANCES,	@PP_K_STATUS,
													@PP_F_INIT,			@PP_F_FINISH,			@PP_K_VENDOR
		END
															--	EMPLEADO	USUARIO		NOMBRE
	ELSE IF @PP_K_USUARIO_ACCION IN (57,139,69,157,161)			--	7658		57			FABIOLA, 69 MARIA SOSA,		157 BERENICE SOSA
		BEGIN
			EXECUTE	[dbo].[PG_LI_APPROVE_FINANCES]	@PP_K_SISTEMA_EXE,	@PP_K_USUARIO_ACCION,	@PP_K_STATUS,
													@PP_F_INIT,			@PP_F_FINISH,			@PP_K_VENDOR
		END
	-- ////////////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> REVIEW_ESTATUS
-- // STORED PROCEDURE ---> BUSCA EL ULTIMO COMENTARIO REALIZADO 
-- // EN UNA PO Y LO MUESTRA EN LA FICHA AL USUARIO, SIRVE PARA CONOCER
-- // EL MOTIVO DEL RECHAZO DE UNA PO ESPECIALMENTE.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_SK_COMENTARIOS_LOG_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_SK_COMENTARIOS_LOG_PO]
GO
-- EXECUTE [dbo].[PG_SK_COMENTARIOS_LOG_PO] 0,139,9,0
-- EXECUTE [dbo].[PG_SK_COMENTARIOS_LOG_PO] 0,139,2,0
CREATE PROCEDURE [dbo].[PG_SK_COMENTARIOS_LOG_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''	
	-- ///////////////////////////////////////////			
	SELECT		TOP (1)
				ISNULL(PO_COMENTARIO_LOG.K_HEADER_PURCHASE_ORDER,'') AS K_HEADER_PURCHASE_ORDER,
				ISNULL(C_PO_COMENTARIO_LOG,'') AS COMENTARIO
				-- =============================	
	FROM		HEADER_PURCHASE_ORDER	(NOLOCK),
				PO_COMENTARIO_LOG		(NOLOCK)
				-- =============================
	WHERE		PO_COMENTARIO_LOG.K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND			PO_COMENTARIO_LOG.K_PO_TEMPORAL=@PP_K_PO_TEMPORAL
	AND			PO_COMENTARIO_LOG.K_USUARIO=@PP_K_USUARIO_ACCION
	AND			HEADER_PURCHASE_ORDER.L_BORRADO<>1
	ORDER BY	K_PO_COMENTARIO_LOG DESC
	-- ////////////////////////////////////////////////////////////////////
GO

	
-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> INSERT
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_IN_HEADER_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_IN_HEADER_PURCHASE_ORDER]
GO
-- EXECUTE [dbo].[PG_IN_HEADER_PURCHASE_ORDER]	0, 139,  'TEST' 
CREATE PROCEDURE [dbo].[PG_IN_HEADER_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_C_PURCHASE_ORDER					[VARCHAR](255),
	-- ============================
	@PP_F_DATE_PURCHASE_ORDER				[DATE],
	@PP_F_REQUIRED_PURCHASE_ORDER			[DATE],
	-- ============================
	@PP_ISSUED_BY_PURCHASE_ORDER			[VARCHAR] (150),
	@PP_REQUIRED_PURCHASE_ORDER				[VARCHAR] (150),
	@PP_K_PLACED_BY							[INT],
	@PP_K_APPROVED_BY						[INT],
	-- ============================
	@PP_K_DELIVERY_TO						[INT],
	@PP_D_DELIVERY_TO						[VARCHAR] (250),
	@PP_CONFIRMING_ORDER_WITH				[VARCHAR] (150),
	@PP_K_VENDOR							[INT],
	-- ============================
	@PP_K_TERMS								[INT],
	@PP_K_CURRENCY							[INT],
	@PP_TAX_RATE							[DECIMAL] (10,4),
	-- ============================
	@PP_SUBTOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_IVA_PURCHASE_ORDER					[DECIMAL] (10,4),
	@PP_DISCOUNT_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_TOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	-----=====================================================
	--	PARA DETAILS_PURCHASE_ORDER
	@PP_ITEM_ARRAY							NVARCHAR(MAX),
	@PP_QUANTITY_ARRAY						NVARCHAR(MAX),
	@PP_PRICE_ARRAY							NVARCHAR(MAX),
	@PP_TOTAL_ARRAY							NVARCHAR(MAX),
	@PP_K_PO_PRICE							NVARCHAR(MAX),
	-----=====================================================
	@PP_TOTAL_ITEMS							[INT],
	-----=====================================================
	--	PARA BLANKET
	@PP_L_IS_BLANKET						[INT],
	@PP_K_CUSTOMER							[INT],
	@PP_D_PROGRAM							[VARCHAR](500),
	@PP_ANNUAL_VOLUME						[DECIMAL](10,4),
	@PP_GROSS_VEHICLE_AREA					[DECIMAL](10,4),
	-----=====================================================
	@PP_C_INFO_QUOTATION					[VARCHAR] (500),
	@PP_TERMS_HEADER						[VARCHAR] (500),
	-----=====================================================
	@PP_ADDITIONAL_TAXES_PURCHASE_ORDER		[DECIMAL](10,4)
AS			
DECLARE @VP_MENSAJE						VARCHAR(500) = ''
DECLARE @VP_K_HEADER_PURCHASE_ORDER		INT = 0;
DECLARE @PP_K_PO_TEMPORAL				INT = 0;
DECLARE @VP_K_STATUS					INT = 1;
BEGIN TRANSACTION 
BEGIN TRY
		-- /////////////////////////////////////////////////////////////////////
		-- SE CAMBIA LA FORMA DE ASIGNAR EL ID A LAS ORDENES DE COMPRA.
		SELECT TOP (1) @PP_K_PO_TEMPORAL=K_PO_TEMPORAL
		FROM	HEADER_PURCHASE_ORDER_TEMP		(NOLOCK)
		WHERE	L_EN_USO=0						
		ORDER BY [K_HEADER_PURCHASE_ORDER_TEMP]	

		--	VERIFICAR QUE NO EXISTA EN PRODUCTIVO
			EXECUTE		[PG_RN_PURCHASE_ORDER_INSERT_TEMPORAL]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
																-- ===========================		
																@PP_K_PO_TEMPORAL, @VP_MENSAJE OUTPUT
	-- //////////////////////////////////////////////////////////////
	IF @VP_MENSAJE<>''
	BEGIN
		RAISERROR (@VP_MENSAJE, 16, 1 )
	END
	
	--		IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43)								--SIN OMAR Y RAFA
	-- CAMBIO_FIRMA		--IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43,44,156)			--CON OMAR Y CON RAFA
		IF @PP_K_USUARIO_ACCION IN (62,44,56,47,42,60,43,41)			--CON RAFA	Y SIN OMAR
		BEGIN
			SET @VP_K_STATUS=4
		END

		IF @PP_K_TERMS<>2
		BEGIN
			SET @PP_TERMS_HEADER=''
		END

		DECLARE	@VP_K_STATUS_PAID_ORDER	AS INTEGER	= 10
		IF @PP_L_IS_BLANKET=1
		BEGIN
			SET @VP_K_STATUS_PAID_ORDER=0
		END
	--============================================================================
	--======================================INSERTAR EL HEADER_PURCHASE_ORDER
	--============================================================================
		INSERT INTO HEADER_PURCHASE_ORDER
			(	[K_HEADER_PURCHASE_ORDER],	
				[K_PO_TEMPORAL],			[C_PURCHASE_ORDER],
				-- ============================
				[K_STATUS_PURCHASE_ORDER],				
				-- ============================
				[F_DATE_PURCHASE_ORDER],	[F_REQUIRED_PURCHASE_ORDER],			
				-- ============================
				[ISSUED_BY_PURCHASE_ORDER],	[REQUIRED_PURCHASE_ORDER],				
				[K_PLACED_BY],				[K_APPROVED_BY],
				-- ============================
				[K_DELIVERY_TO],			[D_DELIVERY_TO],
				[CONFIRMING_ORDER_WITH],	[K_VENDOR],
				-- ============================
				[K_TERMS],					[K_CURRENCY],							
				[TAX_RATE],					--[ADDITIONAL_TAXES_PURCHASE_ORDER],		
				--[ADDITIONAL_DISCOUNTS_PURCHASE_ORDER],	
				--[PREPAID_PURCHASE_ORDER],				
				-- ============================
				[TOTAL_ITEMS],
				[SUBTOTAL_PURCHASE_ORDER],	[ADDITIONAL_DISCOUNTS_PURCHASE_ORDER],
				[IVA_PURCHASE_ORDER],		[ADDITIONAL_TAXES_PURCHASE_ORDER],
				[TOTAL_PURCHASE_ORDER],				
				-- ============================
				--[K_ACCOUNT_PURCHASE_ORDER],
				[L_IS_BLANKET],				[C_INFO_QUOTATION],
				[TERMS_HEADER],
				[K_STATUS_PAID_ORDER],
				-- ===========================
				[K_USUARIO_ALTA], [F_ALTA], [K_USUARIO_CAMBIO], [F_CAMBIO],
				[L_BORRADO], [K_USUARIO_BAJA], [F_BAJA]  )
		VALUES	
			(	@VP_K_HEADER_PURCHASE_ORDER, 
				@PP_K_PO_TEMPORAL,				@PP_C_PURCHASE_ORDER, 
				-- ============================
				@VP_K_STATUS, --@PP_K_STATUS_PURCHASE_ORDER,				
				-- ============================
				@PP_F_DATE_PURCHASE_ORDER,		@PP_F_REQUIRED_PURCHASE_ORDER,
				-- ============================
				@PP_ISSUED_BY_PURCHASE_ORDER,	@PP_REQUIRED_PURCHASE_ORDER,				
				@PP_K_PLACED_BY,				@PP_K_APPROVED_BY,
				-- ============================
				@PP_K_DELIVERY_TO,				@PP_D_DELIVERY_TO,
				@PP_CONFIRMING_ORDER_WITH,		@PP_K_VENDOR,
				-- ============================
				@PP_K_TERMS,					@PP_K_CURRENCY,							
				(@PP_TAX_RATE/100),					--0, --@PP_ADDITIONAL_TAXES_PURCHASE_ORDER,		
				--0, --@PP_ADDITIONAL_DISCOUNTS_PURCHASE_ORDER,	
				--0, --@PP_PREPAID_PURCHASE_ORDER,				
				-- ============================
				@PP_TOTAL_ITEMS,
				@PP_SUBTOTAL_PURCHASE_ORDER,	@PP_DISCOUNT_PURCHASE_ORDER,	
				@PP_IVA_PURCHASE_ORDER,			@PP_ADDITIONAL_TAXES_PURCHASE_ORDER,
				@PP_TOTAL_PURCHASE_ORDER,				
				-- ============================
				--0, --@PP_K_ACCOUNT_PURCHASE_ORDER,
				@PP_L_IS_BLANKET,				@PP_C_INFO_QUOTATION,
				@PP_TERMS_HEADER,
				@VP_K_STATUS_PAID_ORDER,
				-- ============================
				@PP_K_USUARIO_ACCION, GETDATE(), @PP_K_USUARIO_ACCION, GETDATE(),
				0, NULL, NULL  )

			IF @@ROWCOUNT = 0
				BEGIN
					SET @VP_MENSAJE='La orden no se ingresó. [PO#'+CONVERT(VARCHAR(10),@VP_K_HEADER_PURCHASE_ORDER)+']'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END				
	
	UPDATE	HEADER_PURCHASE_ORDER_TEMP
	SET		L_EN_USO=1
	WHERE	K_PO_TEMPORAL=@PP_K_PO_TEMPORAL
	
	IF @@ROWCOUNT = 0
	BEGIN
		SET @VP_MENSAJE='La orden temporal no fue actualizada. [PO_TEMP#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+']'
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END							
	
	EXECUTE		[dbo].[PG_IN_DETAILS_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
														-----=====================================================
														@VP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
														@PP_ITEM_ARRAY,		@PP_QUANTITY_ARRAY,
														@PP_PRICE_ARRAY,	@PP_TOTAL_ARRAY,	@PP_K_PO_PRICE,
														@PP_L_IS_BLANKET
	
	EXECUTE		[dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
														-----=====================================================
														@VP_K_HEADER_PURCHASE_ORDER,	@PP_K_PO_TEMPORAL,
														@PP_L_IS_BLANKET,	
														@PP_K_CUSTOMER,					@PP_D_PROGRAM,					
														@PP_ANNUAL_VOLUME,				@PP_GROSS_VEHICLE_AREA

-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Insertar] la [PO]: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_PO_TEMPORAL AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // PARA INSERTAR LOS DETALLES DE LA ORDEN DE COMPRA
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_IN_DETAILS_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_IN_DETAILS_PURCHASE_ORDER]
GO
CREATE PROCEDURE [dbo].[PG_IN_DETAILS_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE			INT,
	@PP_K_USUARIO_ACCION		INT,
	-----=====================================================
	@PP_K_HEADER_PURCHASE_ORDER				INT,
	@PP_K_PO_TEMPORAL						INT,
	@PP_ITEM_ARRAY							NVARCHAR(MAX),
	@PP_QUANTITY_ARRAY						NVARCHAR(MAX),
	@PP_PRICE_ARRAY							NVARCHAR(MAX),
	@PP_TOTAL_ARRAY							NVARCHAR(MAX),
	@PP_K_PO_PRICE_ARRAY					NVARCHAR(MAX),
	@PP_L_IS_BLANKET						INT
	-----=====================================================
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''
	-----=====================================================				
	DECLARE @VP_K_DETAIL_PO	INT = 1
	
	DECLARE @VP_POSICION_ITEM	INT
	DECLARE @VP_POSICION_QTY	INT
	DECLARE @VP_POSICION_PRICE	INT 
	DECLARE @VP_POSICION_TOTAL	INT
	DECLARE @VP_POSICION_PO_PRICE	INT
	DECLARE @VP_VALOR_ITEM		VARCHAR(500)
	DECLARE @VP_VALOR_QTY		VARCHAR(500)
	DECLARE @VP_VALOR_PRICE		VARCHAR(500)
	DECLARE @VP_VALOR_TOTAL		VARCHAR(500)
	DECLARE @VP_VALOR_PO_PRICE		VARCHAR(500)
	--Colocamos un separador al final de los parametros para que funcione bien nuestro codigo
	SET	@PP_ITEM_ARRAY		= @PP_ITEM_ARRAY		+ '/'
	SET	@PP_QUANTITY_ARRAY	= @PP_QUANTITY_ARRAY	+ '/'
	SET	@PP_PRICE_ARRAY		= @PP_PRICE_ARRAY		+ '/'
	SET	@PP_TOTAL_ARRAY		= @PP_TOTAL_ARRAY		+ '/'
	SET	@PP_K_PO_PRICE_ARRAY		= @PP_K_PO_PRICE_ARRAY		+ '/'
	
	--Hacemos un bucle que se repite mientras haya separadores, patindex busca un patron en una cadena y nos devuelve su posicion
	WHILE patindex('%/%' , @PP_ITEM_ARRAY) <> 0
		BEGIN
			SELECT @VP_POSICION_ITEM	=	patindex('%/%' , @PP_ITEM_ARRAY		)
			SELECT @VP_POSICION_QTY		=	patindex('%/%' , @PP_QUANTITY_ARRAY	)
			SELECT @VP_POSICION_PRICE	=	patindex('%/%' , @PP_PRICE_ARRAY	)
			SELECT @VP_POSICION_TOTAL	=	patindex('%/%' , @PP_TOTAL_ARRAY	)
			SELECT @VP_POSICION_PO_PRICE=	patindex('%/%' , @PP_K_PO_PRICE_ARRAY	)

			--Buscamos la posicion de la primera y obtenemos los caracteres hasta esa posicion
			SELECT @VP_VALOR_ITEM		= LEFT(@PP_ITEM_ARRAY		, @VP_POSICION_ITEM		- 1)
			SELECT @VP_VALOR_QTY		= LEFT(@PP_QUANTITY_ARRAY	, @VP_POSICION_QTY		- 1)
			SELECT @VP_VALOR_PRICE		= LEFT(@PP_PRICE_ARRAY		, @VP_POSICION_PRICE	- 1)
			SELECT @VP_VALOR_TOTAL		= LEFT(@PP_TOTAL_ARRAY		, @VP_POSICION_TOTAL	- 1)
			SELECT @VP_VALOR_PO_PRICE	= LEFT(@PP_K_PO_PRICE_ARRAY	, @VP_POSICION_PO_PRICE	- 1)

				IF @PP_L_IS_BLANKET=1
				BEGIN
					DECLARE @VP_K_CLASS_ITEM	AS INT
					DECLARE @VP_D_ITEM			AS NVARCHAR(MAX)
					SELECT	@VP_K_CLASS_ITEM	=K_CLASS_ITEM,
							@VP_D_ITEM			=D_ITEM
					FROM	ITEM		(NOLOCK)
					WHERE	K_ITEM=@VP_VALOR_ITEM

					IF	@VP_K_CLASS_ITEM<>2
					BEGIN
						--SET @VP_MENSAJE='All items must be of type ROW_MATERIAL when creating a Blanket. [ITEM: '+@VP_D_ITEM+']'
						SET @VP_MENSAJE='Todos los ITEMS deben ser de tipo ROW_MATERIAL cuando se crea una PO de tipo Blanket. [ITEM: '+@VP_D_ITEM+']'
						RAISERROR (@VP_MENSAJE, 16, 1 )
					END
				END

					INSERT INTO DETAILS_PURCHASE_ORDER
						(
						[K_HEADER_PURCHASE_ORDER]		,
						[K_PO_TEMPORAL]					,
						[K_DETAILS_PURCHASE_ORDER]		,
						-- ============================	,
						[K_ITEM],						
						-- ============================
						[QUANTITY_ORDER],
						[QUANTITY_RECEIVED],
						[QUANTITY_PENDING],
						-- ============================
						[K_PO_PRICE_LOG],
						[UNIT_PRICE],		[TOTAL_PRICE]
						)
					VALUES
						(
						@PP_K_HEADER_PURCHASE_ORDER,
						@PP_K_PO_TEMPORAL,
						@VP_K_DETAIL_PO,
						@VP_VALOR_ITEM,		
						-- ============================
						@VP_VALOR_QTY,
						0,
						@VP_VALOR_QTY,
						-- ============================
						@VP_VALOR_PO_PRICE,
						@VP_VALOR_PRICE,	@VP_VALOR_TOTAL
						)																		
													
			IF @@ROWCOUNT = 0
				BEGIN
					--SET @VP_MENSAJE='The DETAIL_PURCHASE_ORDER was not inserted. [DETAIL#'+CONVERT(VARCHAR(10),@VP_VALOR_ITEM)+']'
					SET @VP_MENSAJE='El detalle de la Orden de Compra no fue insertado. [DETAIL#'+CONVERT(VARCHAR(10),@VP_VALOR_ITEM)+']'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END	

			--Reemplazamos lo procesado con nada con la funcion stuff
			SELECT @PP_ITEM_ARRAY		= STUFF(@PP_ITEM_ARRAY		, 1, @VP_POSICION_ITEM , '')
			SELECT @PP_QUANTITY_ARRAY	= STUFF(@PP_QUANTITY_ARRAY	, 1, @VP_POSICION_QTY  , '')
			SELECT @PP_PRICE_ARRAY		= STUFF(@PP_PRICE_ARRAY		, 1, @VP_POSICION_PRICE, '')
			SELECT @PP_TOTAL_ARRAY		= STUFF(@PP_TOTAL_ARRAY		, 1, @VP_POSICION_TOTAL, '')
			SELECT @PP_K_PO_PRICE_ARRAY	= STUFF(@PP_K_PO_PRICE_ARRAY, 1, @VP_POSICION_PO_PRICE, '')

			SET @VP_K_DETAIL_PO += 1
		END
	-- ////////////////////////////////////////////////////////////////
	-- ///////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // PARA INSERTAR LOS DETALLES DE LA BLANKET PO
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]
GO
CREATE PROCEDURE [dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE			INT,
	@PP_K_USUARIO_ACCION		INT,
	-----=====================================================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT,
	-----=====================================================
	@PP_L_IS_BLANKET				[INT],
	@PP_K_CUSTOMER					[INT],
	@PP_D_PROGRAM					[VARCHAR](500),
	@PP_ANNUAL_VOLUME				[DECIMAL](10,4),
	@PP_GROSS_VEHICLE_AREA			[DECIMAL](10,4)
AS
	DECLARE @VP_MENSAJE				VARCHAR(300) = ''

	IF @PP_L_IS_BLANKET=1
	BEGIN
					INSERT INTO DETAILS_BLANKET_PURCHASE_ORDER
						(
						[K_HEADER_PURCHASE_ORDER],		[K_PO_TEMPORAL],
						[K_CUSTOMER],					[D_PROGRAM]			,
						[ANNUAL_VOLUME],				[GROSS_VEHICLE_AREA]
						)
					VALUES
						(
						@PP_K_HEADER_PURCHASE_ORDER,	@PP_K_PO_TEMPORAL,
						@PP_K_CUSTOMER,					@PP_D_PROGRAM		,
						@PP_ANNUAL_VOLUME,				@PP_GROSS_VEHICLE_AREA
						)																		
													
			IF @@ROWCOUNT = 0
				BEGIN
					--RAISERROR (@VP_ERROR_1, 16, 1 ) 
					SET @VP_MENSAJE='El DETAIL_BLANKET_PO no fue insertado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END	
	END
	-- ///////////////////////////////////////////////////////////////
GO

-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> INSERT / FICHA
-- // PARA INSERTAR LOS COMENTARIOS EN EL LOG DE COMENTARIOS DE LA PO
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_IN_COMENTARIOS_LOG_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_IN_COMENTARIOS_LOG_PO]
GO
CREATE PROCEDURE [dbo].[PG_IN_COMENTARIOS_LOG_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		[INT],
	@PP_K_PO_TEMPORAL				[INT],
	@PP_C_PO_COMENTARIO_LOG			[VARCHAR](255)
AS			
DECLARE @VP_MENSAJE				VARCHAR(500) = ''
DECLARE @VP_K_HEADER_PURCHASE_ORDER			INT = 0;		
DECLARE @VP_K_PO			INT = 0;		
BEGIN TRANSACTION 
BEGIN TRY
-- /////////////////////////////////////////////////////////////////////
		INSERT	INTO PO_COMENTARIO_LOG 
		(	[K_HEADER_PURCHASE_ORDER]
			,[K_PO_TEMPORAL]
			,[C_PO_COMENTARIO_LOG]
			,[K_USUARIO]
			,[F_COMENTARIO]				)
		VALUES	
		(	@PP_K_HEADER_PURCHASE_ORDER,
			@PP_K_PO_TEMPORAL,
			@PP_C_PO_COMENTARIO_LOG,
			@PP_K_USUARIO_ACCION,
			GETDATE()					)

			IF @@ROWCOUNT = 0
				BEGIN
					--RAISERROR (@VP_ERROR_1, 16, 1 ) 
					SET @VP_MENSAJE='El comentario no fue ingresado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END				
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Insertar] el registro [COMMENT_HEADER_PURCHASE_ORDER]: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / FICHA
-- // PARA ACTUALIZAR EL ENCABEZADO DE LA PO
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_HEADER_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER]
GO
--       EXECUTE [dbo].[PG_UP_HEADER_PURCHASE_ORDER] 0, 139,												
CREATE PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER				[INT],
	@PP_K_PO_TEMPORAL						[INT],
	@PP_C_PURCHASE_ORDER					NVARCHAR(MAX),
	-- ============================
	@PP_F_DATE_PURCHASE_ORDER				[DATE],
	@PP_F_REQUIRED_PURCHASE_ORDER			[DATE],
	-- ============================
	@PP_ISSUED_BY_PURCHASE_ORDER			[VARCHAR] (150),
	@PP_REQUIRED_PURCHASE_ORDER				[VARCHAR] (150),
	@PP_K_PLACED_BY							[INT],
	@PP_K_APPROVED_BY						[INT],
	-- ============================
	@PP_K_DELIVERY_TO						[INT],
	@PP_D_DELIVERY_TO						[VARCHAR] (250),
	@PP_CONFIRMING_ORDER_WITH				[VARCHAR] (150),
	@PP_K_VENDOR							[INT],
	-- ============================
	@PP_K_TERMS								[INT],
	@PP_K_CURRENCY							[INT],
	@PP_TAX_RATE							[DECIMAL] (10,4),
	-- ============================
	@PP_SUBTOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_IVA_PURCHASE_ORDER					[DECIMAL] (10,4),
	@PP_DISCOUNT_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_TOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	-----=====================================================
	@PP_ITEM_ARRAY							NVARCHAR(MAX),
	@PP_QUANTITY_ARRAY						NVARCHAR(MAX),
	@PP_PRICE_ARRAY							NVARCHAR(MAX),
	@PP_TOTAL_ARRAY							NVARCHAR(MAX),
	@PP_K_PO_PRICE_ARRAY					NVARCHAR(MAX),
	-----=====================================================
	@PP_TOTAL_ITEMS							[INT],
	-----=====================================================
	--	PARA BLANKET
	@PP_L_IS_BLANKET						[INT],
	@PP_K_CUSTOMER							[INT],
	@PP_D_PROGRAM							[VARCHAR](500),
	@PP_ANNUAL_VOLUME						[DECIMAL](10,4),
	@PP_GROSS_VEHICLE_AREA					[DECIMAL](10,4),
	-----=====================================================
	@PP_C_INFO_QUOTATION					NVARCHAR(MAX),
	@PP_TERMS_HEADER						[VARCHAR](500),
	-----=====================================================
	@PP_ADDITIONAL_TAXES_PURCHASE_ORDER		[DECIMAL](10,4)
AS			
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
BEGIN TRANSACTION 
BEGIN TRY
	-- /////////////////////////////////////////////////////////////////////
	EXECUTE [dbo].[PG_RN_PURCHASE_ORDER_UPDATE]		@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
													@PP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
													@OU_RESULTADO_VALIDACION = @VP_MENSAJE		OUTPUT
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END

		IF @PP_K_TERMS<>2
		BEGIN
			SET @PP_TERMS_HEADER=''
		END

		DECLARE	@VP_K_STATUS_PAID_ORDER	AS INTEGER	= 10
		IF @PP_L_IS_BLANKET=1
		BEGIN
			SET @VP_K_STATUS_PAID_ORDER=0
		END

		UPDATE	HEADER_PURCHASE_ORDER
		SET		
				[C_PURCHASE_ORDER]					= @PP_C_PURCHASE_ORDER,					
				-- ============================		= -- ============================
				[F_DATE_PURCHASE_ORDER]				= @PP_F_DATE_PURCHASE_ORDER,				
				[F_REQUIRED_PURCHASE_ORDER]			= @PP_F_REQUIRED_PURCHASE_ORDER,		
				-- ============================		= -- ============================		
				[ISSUED_BY_PURCHASE_ORDER]			= @PP_ISSUED_BY_PURCHASE_ORDER,			
				[REQUIRED_PURCHASE_ORDER]			= @PP_REQUIRED_PURCHASE_ORDER,				
				[K_PLACED_BY]						= @PP_K_PLACED_BY,
				[K_APPROVED_BY]						= @PP_K_APPROVED_BY,
				-- ============================		= -- ============================		
				[K_DELIVERY_TO]						= @PP_K_DELIVERY_TO,
				[D_DELIVERY_TO]						= @PP_D_DELIVERY_TO,
				[CONFIRMING_ORDER_WITH]				= @PP_CONFIRMING_ORDER_WITH,				
				[K_VENDOR]							= @PP_K_VENDOR,							
				-- ============================		= -- ============================		
				[K_TERMS]							= @PP_K_TERMS,								
				[K_CURRENCY]						= @PP_K_CURRENCY,							
				[TAX_RATE]							= (@PP_TAX_RATE/100),
				-- ============================		= -- ============================		
				[TOTAL_ITEMS]						= @PP_TOTAL_ITEMS,							
				[SUBTOTAL_PURCHASE_ORDER]			= @PP_SUBTOTAL_PURCHASE_ORDER,				
				[IVA_PURCHASE_ORDER]				= @PP_IVA_PURCHASE_ORDER,
				[ADDITIONAL_TAXES_PURCHASE_ORDER]	= @PP_ADDITIONAL_TAXES_PURCHASE_ORDER,					
				[ADDITIONAL_DISCOUNTS_PURCHASE_ORDER]=@PP_DISCOUNT_PURCHASE_ORDER,
				[TOTAL_PURCHASE_ORDER]				= @PP_TOTAL_PURCHASE_ORDER,				
				-- ============================		= -- ============================
				[L_IS_BLANKET]						= @PP_L_IS_BLANKET,
				[C_INFO_QUOTATION]					= @PP_C_INFO_QUOTATION,
				[TERMS_HEADER]						= @PP_TERMS_HEADER,
				[K_STATUS_PAID_ORDER]				= @VP_K_STATUS_PAID_ORDER,
				-- ============================		= -- ============================
				[F_CAMBIO]							= GETDATE(), 
				[K_USUARIO_CAMBIO]					= @PP_K_USUARIO_ACCION
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='La orden no fue actualizada. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END		

		DELETE 
		FROM	DETAILS_PURCHASE_ORDER
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

		DELETE 
		FROM	DETAILS_BLANKET_PURCHASE_ORDER
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

		EXECUTE		[dbo].[PG_IN_DETAILS_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
															-----=====================================================
															@PP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
															@PP_ITEM_ARRAY,		@PP_QUANTITY_ARRAY,
															@PP_PRICE_ARRAY,	@PP_TOTAL_ARRAY,	@PP_K_PO_PRICE_ARRAY,
															@PP_L_IS_BLANKET

		EXECUTE		[dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
															-----=====================================================
															@PP_K_HEADER_PURCHASE_ORDER,	@PP_K_PO_TEMPORAL,
															@PP_L_IS_BLANKET,	
															@PP_K_CUSTOMER,					@PP_D_PROGRAM,					
															@PP_ANNUAL_VOLUME,				@PP_GROSS_VEHICLE_AREA
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Actualizar] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////	
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / FICHA
-- // SP PARA CTUALIZAR UNA ORDEN DE COMPRA CUÁNDO YA FUE APROBADA
-- // CAMBIA EL ESTATUS DE LA ORDEN DE COMPRA Y LO REGRESA A PENDIENTE
-- // DE IMPRIMIR.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_HEADER_PURCHASE_ORDER_FINANCES]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_FINANCES]
GO
--       EXECUTE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_FINANCES] 0, 139,												
CREATE PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_FINANCES]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER				[INT],
	@PP_K_PO_TEMPORAL						[INT],
	@PP_C_PURCHASE_ORDER					NVARCHAR(MAX),
	@PP_C_PURCHASE_ORDER_REVIEW				NVARCHAR(MAX),	-- SE AGREGA PARA FORZAR EL GUARDADO DE UNA ORDEN MODIFICADA.			ASDF
	-- ============================
	@PP_F_DATE_PURCHASE_ORDER				[DATE],
	@PP_F_REQUIRED_PURCHASE_ORDER			[DATE],
	-- ============================
	@PP_ISSUED_BY_PURCHASE_ORDER			[VARCHAR] (150),
	@PP_REQUIRED_PURCHASE_ORDER				[VARCHAR] (150),
	@PP_K_PLACED_BY							[INT],
	@PP_K_APPROVED_BY						[INT],
	-- ============================
	@PP_K_DELIVERY_TO						[INT],
	@PP_D_DELIVERY_TO						[VARCHAR] (250),
	@PP_CONFIRMING_ORDER_WITH				[VARCHAR] (150),
	@PP_K_VENDOR							[INT],
	-- ============================
	@PP_K_TERMS								[INT],
	@PP_K_CURRENCY							[INT],
	@PP_TAX_RATE							[DECIMAL] (10,4),
	-- ============================
	@PP_SUBTOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_IVA_PURCHASE_ORDER					[DECIMAL] (10,4),
	@PP_DISCOUNT_PURCHASE_ORDER				[DECIMAL] (10,4),
	@PP_TOTAL_PURCHASE_ORDER				[DECIMAL] (10,4),
	-----=====================================================
	@PP_ITEM_ARRAY							NVARCHAR(MAX),
	@PP_QUANTITY_ARRAY						NVARCHAR(MAX),
	@PP_PRICE_ARRAY							NVARCHAR(MAX),
	@PP_TOTAL_ARRAY							NVARCHAR(MAX),
	@PP_K_PO_PRICE_ARRAY					NVARCHAR(MAX),
	-----=====================================================
	@PP_TOTAL_ITEMS							[INT],
	-----=====================================================
	--	PARA BLANKET
	@PP_L_IS_BLANKET						[INT],
	@PP_K_CUSTOMER							[INT],
	@PP_D_PROGRAM							[VARCHAR](500),
	@PP_ANNUAL_VOLUME						[DECIMAL](10,4),
	@PP_GROSS_VEHICLE_AREA					[DECIMAL](10,4),
	-----=====================================================
	@PP_C_INFO_QUOTATION					NVARCHAR(MAX),
	@PP_TERMS_HEADER						[VARCHAR](500),
	-----=====================================================
	@PP_ADDITIONAL_TAXES_PURCHASE_ORDER		[DECIMAL](10,4)
AS			
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
BEGIN TRANSACTION 
BEGIN TRY
	-- /////////////////////////////////////////////////////////////////////
	EXECUTE [dbo].[PG_RN_PURCHASE_ORDER_EDIT_FINANCES]		@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
													@PP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
													@OU_RESULTADO_VALIDACION = @VP_MENSAJE		OUTPUT
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END

		IF @PP_K_TERMS<>2
		BEGIN
			SET @PP_TERMS_HEADER=''
		END

		DECLARE	@VP_K_STATUS_PAID_ORDER	AS INTEGER	= 10
		IF @PP_L_IS_BLANKET=1
		BEGIN
			SET @VP_K_STATUS_PAID_ORDER=0
		END

		UPDATE	HEADER_PURCHASE_ORDER
		SET		
				[C_PURCHASE_ORDER]					= @PP_C_PURCHASE_ORDER,					
				-- ============================		= -- ============================
				[F_DATE_PURCHASE_ORDER]				= @PP_F_DATE_PURCHASE_ORDER,				
				[F_REQUIRED_PURCHASE_ORDER]			= @PP_F_REQUIRED_PURCHASE_ORDER,		
				-- ============================		= -- ============================		
				[ISSUED_BY_PURCHASE_ORDER]			= @PP_ISSUED_BY_PURCHASE_ORDER,			
				[REQUIRED_PURCHASE_ORDER]			= @PP_REQUIRED_PURCHASE_ORDER,				
				[K_PLACED_BY]						= @PP_K_PLACED_BY,
				[K_APPROVED_BY]						= @PP_K_APPROVED_BY,
				-- ============================		= -- ============================		
				[K_DELIVERY_TO]						= @PP_K_DELIVERY_TO,
				[D_DELIVERY_TO]						= @PP_D_DELIVERY_TO,
				[CONFIRMING_ORDER_WITH]				= @PP_CONFIRMING_ORDER_WITH,				
				[K_VENDOR]							= @PP_K_VENDOR,							
				-- ============================		= -- ============================		
				[K_TERMS]							= @PP_K_TERMS,								
				[K_CURRENCY]						= @PP_K_CURRENCY,							
				[TAX_RATE]							= (@PP_TAX_RATE/100),
				-- ============================		= -- ============================		
				[TOTAL_ITEMS]						= @PP_TOTAL_ITEMS,							
				[SUBTOTAL_PURCHASE_ORDER]			= @PP_SUBTOTAL_PURCHASE_ORDER,				
				[IVA_PURCHASE_ORDER]				= @PP_IVA_PURCHASE_ORDER,
				[ADDITIONAL_TAXES_PURCHASE_ORDER]	= @PP_ADDITIONAL_TAXES_PURCHASE_ORDER,					
				[ADDITIONAL_DISCOUNTS_PURCHASE_ORDER]=@PP_DISCOUNT_PURCHASE_ORDER,
				[TOTAL_PURCHASE_ORDER]				= @PP_TOTAL_PURCHASE_ORDER,				
				-- ============================		= -- ============================
				[L_IS_BLANKET]						= @PP_L_IS_BLANKET,
				[C_INFO_QUOTATION]					= @PP_C_INFO_QUOTATION,
				[TERMS_HEADER]						= @PP_TERMS_HEADER,
				[K_STATUS_PAID_ORDER]				= @VP_K_STATUS_PAID_ORDER,
				-- ============================		= -- ============================
				[F_CAMBIO]							= GETDATE(), 
				[K_USUARIO_CAMBIO]					= @PP_K_USUARIO_ACCION
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='La orden no fue actualizada. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END		

		DELETE 
		FROM	DETAILS_PURCHASE_ORDER
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

		DELETE 
		FROM	DETAILS_BLANKET_PURCHASE_ORDER
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

		EXECUTE		[dbo].[PG_IN_DETAILS_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
															-----=====================================================
															@PP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
															@PP_ITEM_ARRAY,		@PP_QUANTITY_ARRAY,
															@PP_PRICE_ARRAY,	@PP_TOTAL_ARRAY,	@PP_K_PO_PRICE_ARRAY,
															@PP_L_IS_BLANKET

		EXECUTE		[dbo].[PG_INUP_DETAILS_BLANKET_PURCHASE_ORDER]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
															-----=====================================================
															@PP_K_HEADER_PURCHASE_ORDER,	@PP_K_PO_TEMPORAL,
															@PP_L_IS_BLANKET,	
															@PP_K_CUSTOMER,					@PP_D_PROGRAM,					
															@PP_ANNUAL_VOLUME,				@PP_GROSS_VEHICLE_AREA

	-- OBTIENE EL ESTATUS ACTUAL ANTES DE REGRESAR A PENDIENTE DE IMPRIMIR O PENDIENTE FINANZAS
	DECLARE @VP_ESTATUS_PO_DEPTS	AS INT
	
	SELECT	@VP_ESTATUS_PO_DEPTS= K_STATUS_PURCHASE_ORDER 
	FROM	HEADER_PURCHASE_ORDER	(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER	= @PP_K_HEADER_PURCHASE_ORDER

	IF	@VP_ESTATUS_PO_DEPTS = 4
	BEGIN
		SET @VP_ESTATUS_PO_DEPTS	= 4
	END
	ELSE IF	@VP_ESTATUS_PO_DEPTS = 5
	BEGIN
		SET @VP_ESTATUS_PO_DEPTS	= 4
	END
	ELSE IF	@VP_ESTATUS_PO_DEPTS IN (6,7,8,9,11)
	BEGIN
		SET @VP_ESTATUS_PO_DEPTS	= 6
	END
	ELSE
	BEGIN
		RAISERROR ('Estatus no valido para realizar la acción, verifique...', 16, 1 ) 
	END

	UPDATE	HEADER_PURCHASE_ORDER
	SET		K_STATUS_PURCHASE_ORDER	= @VP_ESTATUS_PO_DEPTS
	WHERE	K_HEADER_PURCHASE_ORDER	= @PP_K_HEADER_PURCHASE_ORDER
	IF @@ROWCOUNT = 0
	BEGIN
		RAISERROR ('No se actualizó el estatus de la PO...', 16, 1 ) 
	END
	
	EXECUTE [dbo].[PG_IN_COMENTARIOS_LOG_PO]	@PP_K_SISTEMA_EXE			,	@PP_K_USUARIO_ACCION		,
												-- ===========================
												@PP_K_HEADER_PURCHASE_ORDER	,	@PP_K_PO_TEMPORAL			,
												@PP_C_PURCHASE_ORDER_REVIEW
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Actualizar] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////	
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / FICHA	PARA ACTUALIZAR TAX_RATE DE LA PO
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_HEADER_PURCHASE_ORDER_TAXRATE]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_TAXRATE]
GO
--       EXECUTE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_TAXRATE] 0, 139,												
CREATE PROCEDURE [dbo].[PG_UP_HEADER_PURCHASE_ORDER_TAXRATE]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT,
	-- ============================
	@PP_TAX_RATE					DECIMAL (10,4),
	-- ============================
	@PP_SUBTOTAL_PURCHASE_ORDER		DECIMAL (10,4),
	@PP_DISCOUNT_PURCHASE_ORDER		DECIMAL (10,4),
	@PP_IVA_PURCHASE_ORDER			DECIMAL (10,4),
	@PP_ADDITIONAL_TAXES_PURCHASE_ORDER		DECIMAL(10,4),
	@PP_TOTAL_PURCHASE_ORDER		DECIMAL (10,4),
	-- ============================
	@PP_C_PURCHASE_ORDER			NVARCHAR(MAX)
AS
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
DECLARE @VP_K_ESTATUS			INT
BEGIN TRANSACTION 
BEGIN TRY
	-- /////////////////////////////////////////////////////////////////////
	-- LA MODIFICACIÓN SÓLO LA PUEDEN REALIZAR LOS USUARIOS DE FINANZAS
	IF @PP_K_USUARIO_ACCION IN (57,139,69,157,161,60)
	BEGIN
		UPDATE	HEADER_PURCHASE_ORDER
			SET	
				[C_PURCHASE_ORDER]					= @PP_C_PURCHASE_ORDER,
				-- ============================		= -- ============================			
				[TAX_RATE]							= (@PP_TAX_RATE/100),
				-- ============================		= -- ============================			
				[SUBTOTAL_PURCHASE_ORDER]			= @PP_SUBTOTAL_PURCHASE_ORDER,				
				[ADDITIONAL_DISCOUNTS_PURCHASE_ORDER]=@PP_DISCOUNT_PURCHASE_ORDER,
				[IVA_PURCHASE_ORDER]				= @PP_IVA_PURCHASE_ORDER,
				[ADDITIONAL_TAXES_PURCHASE_ORDER]	= @PP_ADDITIONAL_TAXES_PURCHASE_ORDER,					
				[TOTAL_PURCHASE_ORDER]				= @PP_TOTAL_PURCHASE_ORDER,
				-- ============================		= -- ============================
				[F_CAMBIO]							= GETDATE(), 
				[K_USUARIO_CAMBIO]					= @PP_K_USUARIO_ACCION
		WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

		IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='El valor del [TAX_RATE] no fue actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END
	END

COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Actualizar] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / FICHA
-- // PARA CERRAR UNA ORDEN DE MANERA PARCIAL A PESAR DE HABER RECIBIDO MATERIAL POR PARTE DEL PROVEEDOR
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_CLOSE_PARTIAL]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_CLOSE_PARTIAL]
GO
--       EXECUTE [dbo].[PG_UP_CLOSE_PARTIAL] 0, 139, 'COMENTARIO DE PRUEBA'
CREATE PROCEDURE [dbo].[PG_UP_CLOSE_PARTIAL]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT,
	@PP_C_CLOSURE_PO				NVARCHAR(MAX),
	-- ===========================
	@PP_F_INIT						DATE
AS			
DECLARE  @VP_MENSAJE				NVARCHAR(MAX) = ''
		,@VP_STATUS_PO				INT

BEGIN TRANSACTION 
BEGIN TRY
	-- /////////////////////////////////////////////////////////////////////
	--EXECUTE [dbo].[PG_RN_PURCHASE_ORDER_UPDATE]		@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
	--												@PP_K_HEADER_PURCHASE_ORDER, @PP_K_PO_TEMPORAL,
	--												@OU_RESULTADO_VALIDACION = @VP_MENSAJE		OUTPUT
	-- /////////////////////////////////////////////////////////////////////
	SELECT	@VP_STATUS_PO			= K_STATUS_PURCHASE_ORDER
	FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER	= @PP_K_HEADER_PURCHASE_ORDER
	AND		K_PO_TEMPORAL			= @PP_K_PO_TEMPORAL

	IF @VP_STATUS_PO <> 13
		RAISERROR ('No es posible modificar la [PO], Verifique...', 16, 1 )


		UPDATE	HEADER_PURCHASE_ORDER
		SET		
				-- ============================	= -- ============================
				[K_STATUS_PURCHASE_ORDER]		=	14,
				-- ============================	= -- ============================
				[F_CAMBIO]						= @PP_F_INIT, 
				[K_USUARIO_CAMBIO]				= @PP_K_USUARIO_ACCION
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='El [STATUS(#14)] no fue cambiado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END

		INSERT	INTO [PO_PARTIAL_CLOSED_LOG]
		(	[C_PO_PARTIAL_CLOSED_LOG]	,	[K_HEADER_PURCHASE_ORDER]	,
			[K_USUARIO]					,	[F_PO_PARTIAL_CLOSED_LOG]	)
		VALUES
		(	@PP_C_CLOSURE_PO			,	@PP_K_HEADER_PURCHASE_ORDER,
		@PP_K_USUARIO_ACCION			,	@PP_F_INIT					)
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='Los comentarios no fueron ingresados al LOG. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Actualizar] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////	
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / FICHA
-- // PARA CANCELAR UNA ORDEN EN CUALQUIERA DE LOS STATUS QUE SE ENCUENTRE LA PO.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_CANCEL_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_CANCEL_PO]
GO
--       EXECUTE [dbo].[PG_UP_CANCEL_PO] 0, 139, 'COMENTARIO DE PRUEBA'
CREATE PROCEDURE [dbo].[PG_UP_CANCEL_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT,
	-- ===========================
	@PP_F_INIT						DATE
AS			
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
DECLARE @VP_K_ESTATUS			INT
BEGIN TRANSACTION 
BEGIN TRY
	SELECT	@VP_K_ESTATUS=K_STATUS_PURCHASE_ORDER
	FROM	HEADER_PURCHASE_ORDER	(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		K_PO_TEMPORAL=@PP_K_PO_TEMPORAL

	-- /////////////////////////////////////////////////////////////////////
	IF @VP_K_ESTATUS NOT IN (0)
	BEGIN
		UPDATE	HEADER_PURCHASE_ORDER
		SET		
				-- ============================	= -- ============================
				[K_STATUS_PURCHASE_ORDER]		=	0,
				[K_STATUS_PAID_ORDER]			=	0,
				-- ============================	= -- ============================
				[F_CAMBIO]						= @PP_F_INIT, 
				[K_USUARIO_CAMBIO]				= @PP_K_USUARIO_ACCION
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='El ESTATUS no fue cambiado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END
	END
	ELSE
	BEGIN
		SET @VP_MENSAJE='La orden de compra ya se encuenrta cancelada...'
	END
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [Actualizar] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////	
GO


-- //////////////////////////////////////////////////////////////
-- // PARA ACTUALIZAR LOS DETALLES DE LA ORDEN DE COMPRA
-- // LA CANTIDAD DE ARTÍCULOS RECIBIDOS.
-- // STORED PROCEDURE ---> SELECT / FICHA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_DETAILS_RECEIVED]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_DETAILS_RECEIVED]
GO
 --				EXECUTE [PG_UP_DETAILS_RECEIVED] 0,139,4 , '20/19/31/17/18' , '1/2/3/4/5' , '0/0/0/0/0' , '0/1/2/3/4' , '1/1/1/1/1' , '13'
 CREATE PROCEDURE [dbo].[PG_UP_DETAILS_RECEIVED]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-----=====================================================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT,
	@PP_ITEM_ARRAY					NVARCHAR(MAX),
	@PP_QUANTITY_ORDER_ARRAY		NVARCHAR(MAX),
	@PP_QUANTITY_RECEI_ARRAY		NVARCHAR(MAX),
	@PP_QUANTITY_PENDI_ARRAY		NVARCHAR(MAX),
	@PP_QUANTITY_PENDO_ARRAY		NVARCHAR(MAX),
	@PP_K_STATUS_PO					INT,
	-----=====================================================
	@PP_F_INIT						DATE
AS
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
BEGIN TRANSACTION 
BEGIN TRY
	-----=====================================================					
	DECLARE @VP_STATUS_PO_IN_BD	INT=-1
	DECLARE @VP_DATE_PROMISE	DATE
	-----=====================================================					
	DECLARE @VP_POSICION_ITEM	INT
	DECLARE @VP_POSICION_QTY_OR	INT
	DECLARE @VP_POSICION_QTY_RE	INT
	DECLARE @VP_POSICION_QTY_PE	INT
	DECLARE @VP_POSICION_QTY_PN	INT
	-----=====================================================		
	DECLARE @VP_VALOR_ITEM		VARCHAR(500)
	DECLARE @VP_VALOR_QTY_OR	VARCHAR(500)
	DECLARE @VP_VALOR_QTY_RE	VARCHAR(500)
	DECLARE @VP_VALOR_QTY_PE	VARCHAR(500)
	DECLARE @VP_VALOR_QTY_PN	VARCHAR(500)
	-----=====================================================
	SELECT	@VP_STATUS_PO_IN_BD=K_STATUS_PURCHASE_ORDER,
			@VP_DATE_PROMISE=F_PROMISE_PURCHASE_ORDER
	FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

	IF @VP_DATE_PROMISE IS NULL
	BEGIN
		SET	@VP_DATE_PROMISE = @PP_F_INIT
	END

	IF @VP_STATUS_PO_IN_BD<>@PP_K_STATUS_PO
	BEGIN
		SET @VP_MENSAJE='Estatus de la orden no válido para realizar la acción, verifica. [ESTATUS_IN_BD# '+CONVERT(VARCHAR(10),@VP_STATUS_PO_IN_BD)+']'
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END

	-----=====================================================
	--Colocamos un separador al final de los parametros para que funcione bien nuestro codigo
	SET	@PP_ITEM_ARRAY				= @PP_ITEM_ARRAY		+ '/'
	SET	@PP_QUANTITY_ORDER_ARRAY	= @PP_QUANTITY_ORDER_ARRAY	+ '/'
	SET	@PP_QUANTITY_RECEI_ARRAY	= @PP_QUANTITY_RECEI_ARRAY	+ '/'
	SET	@PP_QUANTITY_PENDI_ARRAY	= @PP_QUANTITY_PENDI_ARRAY	+ '/'
	SET	@PP_QUANTITY_PENDO_ARRAY	= @PP_QUANTITY_PENDO_ARRAY	+ '/'
	
	--Hacemos un bucle que se repite mientras haya separadores, patindex busca un patron en una cadena y nos devuelve su posicion
	WHILE patindex('%/%' , @PP_ITEM_ARRAY) <> 0
	BEGIN
		SELECT @VP_POSICION_ITEM	=	patindex('%/%' , @PP_ITEM_ARRAY		)
		SELECT @VP_POSICION_QTY_OR	=	patindex('%/%' , @PP_QUANTITY_ORDER_ARRAY	)
		SELECT @VP_POSICION_QTY_RE	=	patindex('%/%' , @PP_QUANTITY_RECEI_ARRAY	)
		SELECT @VP_POSICION_QTY_PE	=	patindex('%/%' , @PP_QUANTITY_PENDI_ARRAY	)
		SELECT @VP_POSICION_QTY_PN	=	patindex('%/%' , @PP_QUANTITY_PENDO_ARRAY	)

		--Buscamos la posicion de la primera y obtenemos los caracteres hasta esa posicion
		SELECT @VP_VALOR_ITEM		= LEFT(@PP_ITEM_ARRAY		, @VP_POSICION_ITEM		- 1)
		SELECT @VP_VALOR_QTY_OR		= LEFT(@PP_QUANTITY_ORDER_ARRAY	, @VP_POSICION_QTY_OR	- 1)
		SELECT @VP_VALOR_QTY_RE		= LEFT(@PP_QUANTITY_RECEI_ARRAY	, @VP_POSICION_QTY_RE	- 1)
		SELECT @VP_VALOR_QTY_PE		= LEFT(@PP_QUANTITY_PENDI_ARRAY	, @VP_POSICION_QTY_PE	- 1)
		SELECT @VP_VALOR_QTY_PN		= LEFT(@PP_QUANTITY_PENDO_ARRAY	, @VP_POSICION_QTY_PN	- 1)
	
		DECLARE @VP_TOTAL_PENDIENTE DECIMAL = 0
		DECLARE @VP_TOTAL_RECIBIDA	DECIMAL = 0

		IF CONVERT(DECIMAL(19,4),@VP_VALOR_QTY_RE)>0
		BEGIN
				IF @PP_K_STATUS_PO=11
				BEGIN
					SET @VP_TOTAL_PENDIENTE =	CONVERT(DECIMAL,@VP_VALOR_QTY_PE)
					SET @VP_TOTAL_RECIBIDA	=	CONVERT(DECIMAL,(@VP_VALOR_QTY_RE))
				END
				ELSE
				BEGIN
					SET	@VP_TOTAL_RECIBIDA	=	(CONVERT(DECIMAL,(@VP_VALOR_QTY_RE)) + CONVERT(DECIMAL,@VP_VALOR_QTY_PN))
					SET @VP_TOTAL_PENDIENTE =	CONVERT(DECIMAL,@VP_VALOR_QTY_OR) - @VP_TOTAL_RECIBIDA
				END
				
				UPDATE	[DETAILS_PURCHASE_ORDER]
				SET		--[QUANTITY_ORDER]	=	@VP_VALOR_QTY_OR,
						[QUANTITY_RECEIVED]	=	@VP_TOTAL_RECIBIDA,
						[QUANTITY_PENDING]	=	@VP_TOTAL_PENDIENTE
				WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
				AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
				AND		[K_ITEM]=@VP_VALOR_ITEM
				
				IF @@ROWCOUNT = 0
					BEGIN
						SET @VP_MENSAJE='El detalle de la orden no puede ser actualizado. [ITEM#'+CONVERT(VARCHAR(10),@VP_VALOR_ITEM)+']'
						RAISERROR (@VP_MENSAJE, 16, 1 ) 
					END

				INSERT INTO	LOG_DETAILS_PURCHASE_ORDER
				(	[K_HEADER_PURCHASE_ORDER]	
					,[K_PO_TEMPORAL]				
					-- ============================
					,[K_ITEM]					
					,[K_STATUS_PO]				
					-- ============================
					,[QUANTITY_ORDER]			
					,[QUANTITY_RECEIVED]			
					,[QUANTITY_PENDING]			
					,[QUANTITY_PENDING_ORIGINAL]	
					-- ============================
					,[F_ALTA]						
					,[K_USUARIO_ALTA]		)
				VALUES
				(	@PP_K_HEADER_PURCHASE_ORDER				
					,@PP_K_PO_TEMPORAL							
					-- ============================
					,@VP_VALOR_ITEM								
					,@PP_K_STATUS_PO							
					-- ============================
					,@VP_VALOR_QTY_OR						
					,@VP_VALOR_QTY_RE						
					,@VP_VALOR_QTY_PE						
					,@VP_VALOR_QTY_PN
					-- ============================
					,@PP_F_INIT						
					,@PP_K_USUARIO_ACCION	)		

				IF @@ROWCOUNT = 0
					BEGIN
						SET @VP_MENSAJE='El LOG no puede ser actualizado. [ITEM#'+CONVERT(VARCHAR(10),@VP_VALOR_ITEM)+']'
						RAISERROR (@VP_MENSAJE, 16, 1 ) 
					END
		END
		--Reemplazamos lo procesado con nada con la funcion stuff
		SELECT @PP_ITEM_ARRAY			= STUFF(@PP_ITEM_ARRAY				, 1, @VP_POSICION_ITEM		, '')
		SELECT @PP_QUANTITY_ORDER_ARRAY	= STUFF(@PP_QUANTITY_ORDER_ARRAY	, 1, @VP_POSICION_QTY_OR	, '')
		SELECT @PP_QUANTITY_RECEI_ARRAY	= STUFF(@PP_QUANTITY_RECEI_ARRAY	, 1, @VP_POSICION_QTY_RE	, '')
		SELECT @PP_QUANTITY_PENDI_ARRAY	= STUFF(@PP_QUANTITY_PENDI_ARRAY	, 1, @VP_POSICION_QTY_PE	, '')
		SELECT @PP_QUANTITY_PENDO_ARRAY	= STUFF(@PP_QUANTITY_PENDO_ARRAY	, 1, @VP_POSICION_QTY_PN	, '')
	END
-- ///////////////////////////////////////////
	DECLARE @VP_SUMA_PENDIENTES		DECIMAL(16,4)	= -1

SELECT	@VP_SUMA_PENDIENTES=SUM(QUANTITY_PENDING)
FROM	DETAILS_PURCHASE_ORDER		(NOLOCK)
WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

	IF @VP_SUMA_PENDIENTES IS NULL	OR	@VP_SUMA_PENDIENTES=-1
	BEGIN
		SET @VP_MENSAJE='El estatus de la Orden no puede ser actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END
	
	IF @VP_SUMA_PENDIENTES=0			
	BEGIN
		UPDATE	[HEADER_PURCHASE_ORDER]
		SET		[K_STATUS_PURCHASE_ORDER]	= 12,
				[F_RECEIVED_PURCHASE_ORDER]	= @PP_F_INIT,
				[F_PROMISE_PURCHASE_ORDER]	= @VP_DATE_PROMISE
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='El STATUS(12) no fue actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END
	END
	ELSE
	BEGIN
		UPDATE	[HEADER_PURCHASE_ORDER]
		SET		[K_STATUS_PURCHASE_ORDER]	= 13,
				[F_RECEIVED_PURCHASE_ORDER]	= @PP_F_INIT,
				[F_PROMISE_PURCHASE_ORDER]	= @VP_DATE_PROMISE
		WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='El STATUS(13) no fue actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END
	END
-- ///////////////////////////////////////////

-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	
	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] la [PO]: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / DATE_RECEIVED
-- // PARA ACTUALIZAR LA FECHA DE RECEPCIÓN DE LAS PO
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_DATE_RECEIVED_PO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_DATE_RECEIVED_PO]
GO
--		 EXECUTE [dbo].[PG_UP_DATE_RECEIVED_PO]	0,129,  4,1
CREATE PROCEDURE [dbo].[PG_UP_DATE_RECEIVED_PO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_PO_ARRAY					[NVARCHAR](MAX),
	@PP_TM_ARRAY					[NVARCHAR](MAX),
	@PP_F_RECEIVED					DATE
AS
DECLARE @VP_MENSAJE			VARCHAR(500)=''

DECLARE @VP_POSICION_PO		INT
DECLARE @VP_POSICION_TM		INT
DECLARE @VP_VALOR_PO		VARCHAR(500)
DECLARE @VP_VALOR_TM		VARCHAR(500)

DECLARE @VP_ESTATUS_PO		INT
-- /////////////////////////////////////////////////////////////////////
BEGIN TRANSACTION 
BEGIN TRY
	IF @VP_MENSAJE=''
	--Colocamos un separador al final de los parametros para que funcione bien nuestro codigo
	SET	@PP_PO_ARRAY		= @PP_PO_ARRAY		+ '/'
	SET	@PP_TM_ARRAY		= @PP_TM_ARRAY		+ '/'

		--Hacemos un bucle que se repite mientras haya separadores, patindex busca un patron en una cadena y nos devuelve su posicion
	WHILE patindex('%/%' , @PP_PO_ARRAY) <> 0
		BEGIN
			SELECT @VP_POSICION_PO	=	patindex('%/%' , @PP_PO_ARRAY		)
			SELECT @VP_POSICION_TM	=	patindex('%/%' , @PP_TM_ARRAY		)

			--Buscamos la posicion de la primera y obtenemos los caracteres hasta esa posicion
			SELECT @VP_VALOR_PO		= LEFT(@PP_PO_ARRAY		, @VP_POSICION_PO		- 1)
			SELECT @VP_VALOR_TM		= LEFT(@PP_TM_ARRAY		, @VP_POSICION_TM		- 1)
			
			-- PRIMERO SE VERIFICA QUE TENGA VALOR LA PO. Y QUE SE ENCUENTRE ACTIVA EN LAS PO
			IF @VP_VALOR_PO<>''
			BEGIN
				SELECT	@VP_ESTATUS_PO=K_STATUS_PURCHASE_ORDER
				FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
				WHERE	K_HEADER_PURCHASE_ORDER=@VP_VALOR_PO
				AND		K_PO_TEMPORAL=@VP_VALOR_TM
				AND		K_STATUS_PURCHASE_ORDER IN (11)
				AND		L_BORRADO<>1

				IF @@ROWCOUNT = 0
						BEGIN
							SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@VP_VALOR_PO)+'] no se encuentra activa Verifique...'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END			
			END

			--SE IDENTIFICA EL ESTATUS EN EL QUE SE ENCUENTRA Y SE PROCEDE A ACTUALIZAR.
			IF @VP_MENSAJE=''
			BEGIN
				IF @VP_ESTATUS_PO IN (11)
				BEGIN
					--DECLARE @VP_SIGUIENTE_STATUS INT=1
					--SET @VP_SIGUIENTE_STATUS += @VP_ESTATUS_PO + @PP_K_PO_APROBADA
			
					UPDATE HEADER_PURCHASE_ORDER
					SET
							F_PROMISE_PURCHASE_ORDER=@PP_F_RECEIVED
							--K_STATUS_PURCHASE_ORDER=@VP_SIGUIENTE_STATUS
					WHERE	K_HEADER_PURCHASE_ORDER=@VP_VALOR_PO
					AND		K_PO_TEMPORAL=@VP_VALOR_TM
					AND		L_BORRADO<>1

						IF @@ROWCOUNT = 0
						BEGIN
							--RAISERROR (@VP_ERROR_1, 16, 1 ) 
							SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@VP_VALOR_PO)+'] no fue actualizada...'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END													
				END
			END
			--Reemplazamos lo procesado con nada con la funcion stuff
			SELECT @PP_PO_ARRAY		= STUFF(@PP_PO_ARRAY		, 1, @VP_POSICION_PO , '')
			SELECT @PP_TM_ARRAY		= STUFF(@PP_TM_ARRAY		, 1, @VP_POSICION_TM , '')
		END
	-- ////////////////////////////////////////////////////////////////
	-- ///////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH
-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] la fecha de recepción: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @VP_VALOR_PO AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / PO
-- // PARA ACTUALIZAR EL ESTATUS DE LA PO DESDE LA PANTALLA DE USUARIO QUE LA GENERA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_ESTATUS_PO_SEND_REVIEW]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_ESTATUS_PO_SEND_REVIEW]
GO
--		 EXECUTE [dbo].[PG_UP_ESTATUS_PO_SEND_REVIEW]	0,129,  6
CREATE PROCEDURE [dbo].[PG_UP_ESTATUS_PO_SEND_REVIEW]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT

AS
DECLARE @VP_MENSAJE			VARCHAR(500)=''
DECLARE @VP_ESTATUS_PO		INT
DECLARE	@VP_L_IS_BLANKET	INT
-- /////////////////////////////////////////////////////////////////////
BEGIN TRANSACTION 
BEGIN TRY
	SELECT	@VP_ESTATUS_PO=K_STATUS_PURCHASE_ORDER,
			@VP_L_IS_BLANKET=L_IS_BLANKET
	FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
	AND		L_BORRADO<>1
	IF @@ROWCOUNT = 0
	BEGIN
		SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+'] no fue encontrada, verifique...'
		RAISERROR (@VP_MENSAJE, 16, 1 )
	END			

	IF	@VP_ESTATUS_PO NOT IN (1,3,5,8)
	BEGIN
		SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+'] se enceuntra en Revisión o Autorización.'
		RAISERROR (@VP_MENSAJE, 16, 1 )
	END
	ELSE IF @VP_ESTATUS_PO IN (1,3,5,8)
	BEGIN
		SET	@VP_ESTATUS_PO = 2
		GOTO UPDATE_PO
	END

UPDATE_PO:
	DECLARE	@VP_K_STATUS_PAID_ORDER	AS INTEGER	= 10
	IF @VP_L_IS_BLANKET=1
	BEGIN
		SET @VP_K_STATUS_PAID_ORDER=0
	END

	UPDATE HEADER_PURCHASE_ORDER
	SET
			K_STATUS_PURCHASE_ORDER=@VP_ESTATUS_PO,
			K_STATUS_PAID_ORDER=@VP_K_STATUS_PAID_ORDER
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

	IF @@ROWCOUNT = 0
	BEGIN
		SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+'] no fue actualizada...'
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END		
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH
-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] el [STATUS_PO]: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / PO
-- // PARA ACTUALIZAR EL ESTATUS DE LA PO POR PARTE DE GERENCIA Y FINANZAS(ESTO ANTES DE QUE SE ENVÍE A IMPRIMIR)
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_ESTATUS_PO_MANAGER_DPTO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_ESTATUS_PO_MANAGER_DPTO]
GO
--		 EXECUTE [dbo].[PG_UP_ESTATUS_PO_MANAGER_DPTO]	0,139,  2,1
CREATE PROCEDURE [dbo].[PG_UP_ESTATUS_PO_MANAGER_DPTO]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_PO_ARRAY					[NVARCHAR](MAX),
	@PP_TM_ARRAY					[NVARCHAR](MAX),
	@PP_K_PO_APROBADA				[INT]
AS
DECLARE @VP_MENSAJE			VARCHAR(500)=''
DECLARE @VP_K_VENDOR		INT

DECLARE @VP_POSICION_PO		INT
DECLARE @VP_POSICION_TM		INT
DECLARE @VP_VALOR_PO		VARCHAR(500)
DECLARE @VP_VALOR_TM		VARCHAR(500)

DECLARE @VP_ESTATUS_PO		INT
-- /////////////////////////////////////////////////////////////////////
BEGIN TRANSACTION 
BEGIN TRY
	IF @VP_MENSAJE=''
	--Colocamos un separador al final de los parametros para que funcione bien nuestro codigo
	SET	@PP_PO_ARRAY		= @PP_PO_ARRAY		+ '/'
	SET	@PP_TM_ARRAY		= @PP_TM_ARRAY		+ '/'

		--Hacemos un bucle que se repite mientras haya separadores, patindex busca un patron en una cadena y nos devuelve su posicion
	WHILE patindex('%/%' , @PP_PO_ARRAY) <> 0
		BEGIN
			SELECT @VP_POSICION_PO	=	patindex('%/%' , @PP_PO_ARRAY		)
			SELECT @VP_POSICION_TM	=	patindex('%/%' , @PP_TM_ARRAY		)

			--Buscamos la posicion de la primera y obtenemos los caracteres hasta esa posicion
			SELECT @VP_VALOR_PO		= LEFT(@PP_PO_ARRAY		, @VP_POSICION_PO		- 1)
			SELECT @VP_VALOR_TM		= LEFT(@PP_TM_ARRAY		, @VP_POSICION_TM		- 1)
			
			-- PRIMERO SE VERIFICA QUE TENGA VALOR LA PO. Y QUE SE ENCUENTRE ACTIVA EN LAS PO
			IF @VP_VALOR_PO<>''
			BEGIN
				SELECT	@VP_ESTATUS_PO	=	K_STATUS_PURCHASE_ORDER,
						@VP_K_VENDOR	=	K_VENDOR
				FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
				WHERE	K_HEADER_PURCHASE_ORDER=@VP_VALOR_PO
				AND		[K_PO_TEMPORAL]=@VP_VALOR_TM
				AND		K_STATUS_PURCHASE_ORDER IN (2,4,7)
				AND		L_BORRADO<>1

				IF @@ROWCOUNT = 0
				BEGIN
					SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@VP_VALOR_PO)+'] no puede ser actualizada...'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END			
			END

			--SE IDENTIFICA EL ESTATUS EN EL QUE SE ENCUENTRA Y SE PROCEDE A ACTUALIZAR.
			IF @VP_ESTATUS_PO >= 10
			BEGIN
				SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@VP_VALOR_PO)+'] No fue actualizada. Estatus no válido para realizar la acción, verifique...'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 					
			END
			ELSE IF @VP_ESTATUS_PO IN (2,4,7)		-- AX: 20210106  SE ACTUALIZA, AL ENVIAR A REVISIÓN AL ÁREA DE FINANZAS SE ACTUALIZARÁ LA FECHA DE LA PO, SOLICITUD REALIZADA POR FINANZAS.
			BEGIN
				DECLARE @VP_SIGUIENTE_STATUS INT=1
				SET @VP_SIGUIENTE_STATUS += @VP_ESTATUS_PO + @PP_K_PO_APROBADA
			
				IF @VP_SIGUIENTE_STATUS = 4
				BEGIN
					UPDATE HEADER_PURCHASE_ORDER
					SET
							[K_STATUS_PURCHASE_ORDER]			= @VP_SIGUIENTE_STATUS
							,[F_DATE_PURCHASE_ORDER]			= GETDATE()
							,[F_REQUIRED_PURCHASE_ORDER]		= GETDATE()
					WHERE	K_HEADER_PURCHASE_ORDER=@VP_VALOR_PO
					AND		[K_PO_TEMPORAL]=@VP_VALOR_TM
					AND		L_BORRADO<>1
				END
				ELSE
				BEGIN
					UPDATE HEADER_PURCHASE_ORDER
					SET
							K_STATUS_PURCHASE_ORDER=@VP_SIGUIENTE_STATUS
					WHERE	K_HEADER_PURCHASE_ORDER=@VP_VALOR_PO
					AND		[K_PO_TEMPORAL]=@VP_VALOR_TM
					AND		L_BORRADO<>1
				END

				IF @@ROWCOUNT = 0
				BEGIN
					SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@VP_VALOR_PO)+'] no fue actualizada...'
					RAISERROR (@VP_MENSAJE, 16, 1 ) 
				END			
			END

			-- SI EL ESTATUS SE ENCUENTRA EN (9) QUE ES APROBADO POR GERENCIA DE PLANTA, 
			-- SE ENVIA EL CORREO AL DEPARTAMENTO DE FINANZAS Y AL USUARIO QUE GENERÓ
			-- SE ENVIA CORREO O NOTIFICACIÓN SEGÚN APLIQUE.
			IF @VP_SIGUIENTE_STATUS = 9
			BEGIN
				DECLARE @VP_PO_INT INT;
				DECLARE @VP_TM_INT INT;
				SET @VP_PO_INT = CAST(@VP_VALOR_PO AS INT)
				SET @VP_TM_INT = CAST(@VP_VALOR_TM AS INT)

				EXECUTE [PG_PR_ENVIAR_CORREO_FINANZAS]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION, @VP_PO_INT
				
				EXECUTE [PG_PR_ENVIAR_CORREO_USUARIOS]	@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION, @VP_PO_INT
			END

			--Reemplazamos lo procesado con nada con la funcion stuff
			SELECT @PP_PO_ARRAY		= STUFF(@PP_PO_ARRAY		, 1, @VP_POSICION_PO , '')
			SELECT @PP_TM_ARRAY		= STUFF(@PP_TM_ARRAY		, 1, @VP_POSICION_TM , '')
		END
	-- ////////////////////////////////////////////////////////////////
	-- ///////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH
-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] el [STATUS_PO]: ' + @VP_MENSAJE 
	END
	SELECT	@VP_MENSAJE AS MENSAJE, @VP_VALOR_PO AS CLAVE
	-- //////////////////////////////////////////////////////////////
GO

-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> ENVIAR CORREO
-- // CUANDO LA ORDEN DE COMPRA ES APROBADA POR GERENCIA DE PLANTA SE HACE EL ENVIO DE LA [PO] POR MEDIO ELECTRONICO.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_PR_ENVIAR_CORREO_FINANZAS]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_PR_ENVIAR_CORREO_FINANZAS]
GO
--		 EXECUTE [dbo].[PG_PR_ENVIAR_CORREO_FINANZAS]	0,139,  2
CREATE PROCEDURE [dbo].[PG_PR_ENVIAR_CORREO_FINANZAS]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_VALOR_PO					INT
AS
	BEGIN
		DECLARE @VP_RECIPIENTS	NVARCHAR(MAX)	= '';
		DECLARE @VP_FILE_PATH  NVARCHAR(MAX)	=''	;
--		DECLARE @VP_PO_INT INT;
		DECLARE @VP_SUBJECT NVARCHAR(MAX) ;
		DECLARE @VP_BODY_HTML  NVARCHAR(MAX) ;
		DECLARE @VP_ID_MAIL INT;
		DECLARE @VP_SENT_STATUS VARCHAR(500);
		----================================================================				
		----================================================================
		-- CUANDO SE PONGA EN PRODUCTIVO SE DEBE QUITAR EL COMENTARIO A ESTA LÍNEA
		-- PARA QUE SE ENVIE A TODOS LOS CONTACTOS.					
		--	SELECT  @VP_RECIPIENTS	=	@VP_RECIPIENTS + ';' + EMAIL_1 + ';' + EMAIL_2
		--								FROM	COMPRAS.dbo.VENDOR
		--								WHERE   K_VENDOR = @VP_K_VENDOR
		----================================================================
		IF @PP_K_SISTEMA_EXE=1
		BEGIN
			-- USUARIO DEFAULT DE COMPRAS A DONDE SE ENVIARÁ EL CORREO.
			SET @VP_RECIPIENTS = 'FABIOLAG@PEARLLEATHER.COM.MX'						
		END
			SET @VP_FILE_PATH = '\\10.1.1.5\documents\Common\COMPRAS\REPORTES\PO_'+ CONVERT(VARCHAR(10),FORMAT(@PP_VALOR_PO,'000000')) +'.PDF'  		
			SET @VP_SUBJECT = 'PEARL LEATHER [PO#' + CONVERT(VARCHAR(10),FORMAT(@PP_VALOR_PO,'000000')) +']'--CONVERT(VARCHAR(10),FORMAT(@VP_VALOR_PO,'000000'))+']'					
		

		SET @VP_BODY_HTML =  
		N'<p style="color:black; font-size:12.0pt;font-family:"Calisto MT",serif">'+
		N'Buen día, <br><br>'+
		N'Se envía orden de compra, favor de realizar el seguimiento correspondiente para la entrega.<br>'+
		N'Favor de confirmar de recibido y fecha de entrega estimada.<br><br>'+
		N'Saludos.<br> == = == = == = == = == = == = == = == = == = == = == = == = == = == = ==<br>'+
		N'Good day, <br><br>'+
		N'Purchase order is sent, please track it for delivery.<br>'+
		N'Please confirm receipt and estimated delivery date.<br><br>'+
		N'Regards.<br> </p> <p>'+

		N'<p><span style="color:maroon; font-size:12.0pt"><b>Fabiola Gerardo Arévalo | Compras</b></span><br>'+
		N'<span style="color:lightpink; font-size:11pt"><b>Dirección:</b></span>'+
		N'<span style="color:lightpink; font-size:11pt">Av. Rosa Maria Y. Fuentes 7050-A <b>|C.P.</b> 32320</span></br>'+
		N'<span style="color:lightpink; font-size:11pt"><b>Tel.</b>656-892-5800<b>|Ext:</b>121'+
		N'<b>|Cel.</b> 656-103-4020<o:p></o:p></span><br><br></p>'+
		N'<p><span style="color:maroon; font-size:11pt"><b><u>RECEPCION DE MATERIAL <b>|</b> RECEIPT OF MATERIAL</u></b></span></p>'+
		N'<p><span style="color:maroon; font-size: 8pt"><b>Lunes a Viernes | Monday to Friday: 7am -9am, 10am -2pm y 4pm -5:30pm</b></span></p>'
		
		EXEC msdb.dbo.sp_send_dbmail @recipients=@VP_RECIPIENTS,
--		@copy_recipients = 'ALEJANDROD@PEARLLEATHER.COM.MX',
--		@blind_copy_recipients='ALEJANDROD@PEARLLEATHER.COM.MX',
		@subject = @VP_SUBJECT,
		@body = @VP_BODY_HTML,  
		@body_format = 'HTML', 
		@file_attachments = @VP_FILE_PATH, --EL ARCHIVO A ENVIAR DEBE ESTAR EN EL MISMO (SERVIDOR, EQUIPO) QUE SE TIENE INSTALADO EL SQLSERVER
		@mailitem_id = @VP_ID_MAIL OUTPUT;

			UPDATE	HEADER_PURCHASE_ORDER
			SET		K_STATUS_PURCHASE_ORDER=11
			WHERE	K_HEADER_PURCHASE_ORDER=@PP_VALOR_PO
	END
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> ENVIAR CORREO
-- // PARA ENVIAR CORREO A LOS USUARIOS QUE GENERARON LA ORDEN DE COMPRA.
-- //////////////////////////////////////////////////////////////	
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_PR_ENVIAR_CORREO_USUARIOS]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_PR_ENVIAR_CORREO_USUARIOS]
GO
--		 EXECUTE [dbo].[PG_PR_ENVIAR_CORREO_USUARIOS]	0,139,  2
CREATE PROCEDURE [dbo].[PG_PR_ENVIAR_CORREO_USUARIOS]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_VALOR_PO					INT
AS
DECLARE @VP_MENSAJE			VARCHAR(500)=''
DECLARE @VP_ESTATUS_PO		INT
-- /////////////////////////////////////////////////////////////////////
	SELECT	@VP_ESTATUS_PO	=	K_STATUS_PURCHASE_ORDER
	FROM	HEADER_PURCHASE_ORDER		(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_VALOR_PO
	AND		L_BORRADO<>1
	
	IF @VP_ESTATUS_PO=11
	BEGIN
		DECLARE @VP_RECIPIENTS	NVARCHAR(MAX)	= '';

		DECLARE @VP_SUBJECT NVARCHAR(MAX) ;
		DECLARE @VP_BODY_HTML  NVARCHAR(MAX) ;
		DECLARE @VP_ID_MAIL INT;
		DECLARE @VP_SENT_STATUS VARCHAR(500);
		----================================================================
		--	PARA PRUEBAS
		--SELECT	@VP_RECIPIENTS	=	@VP_RECIPIENTS + ';' + CORREO_GERENTE.CORREO_USUARIO_PEARL + ';' +
		--												   CORREO_USUARIO.CORREO_USUARIO_PEARL
		
		SELECT	@VP_RECIPIENTS	=	@VP_RECIPIENTS + ';' + CORREO_USUARIO.CORREO_USUARIO_PEARL
		
		FROM	HEADER_PURCHASE_ORDER			(NOLOCK)	
		LEFT JOIN BD_GENERAL.DBO.USUARIO_PEARL	(NOLOCK)	AS CORREO_USUARIO ON HEADER_PURCHASE_ORDER.K_USUARIO_ALTA=CORREO_USUARIO.K_USUARIO_PEARL
		--LEFT JOIN BD_GENERAL.DBO.USUARIO_PEARL	AS CORREO_GERENTE ON HEADER_PURCHASE_ORDER.K_APPROVED_BY =CORREO_GERENTE.K_EMPLEADO_PEARL
		WHERE	K_HEADER_PURCHASE_ORDER=@PP_VALOR_PO
					
		----================================================================
		
			IF LEN(@VP_RECIPIENTS)>5
			BEGIN

				SET @VP_SUBJECT = '[PO#' + CONVERT(VARCHAR(10),FORMAT(@PP_VALOR_PO,'000000')) +'] APROBADA'
				
				SET @VP_BODY_HTML =
				N'<span style="color:black; font-size:12pt">	Buen día:<br>' +
				N'La orden de compra indicada en el asunto del mensaje, ha sido aprobada por Gerencia de Planta.<br>'+
				N'Puedes Verificar el estatus del pedido en la pantalla donde generaste la Orden.<br><br>'+
				N'Saludos.</span><br><br>'+	
				N'<p><span style="color:maroon; font-size:12.0pt"><b>Fabiola Gerardo Arévalo | Compras</b></span><br>'+
				N'<span style="color:lightpink; font-size:11pt"><b>Dirección:</b></span>'+
				N'<span style="color:lightpink; font-size:11pt">Av. Rosa Maria Y. Fuentes 7050-A <b>|C.P.</b> 32320</span></br>'+
				N'<span style="color:lightpink; font-size:11pt"><b>Tel.</b>656-892-5800<b>|Ext:</b>121'+
				N'<b>|Cel.</b> 656-103-4020<o:p></o:p></span><br><br></p>'+
				N'<p><span style="color:maroon; font-size:11pt"><b><u>RECEPCION DE MATERIAL <b>|</b> RECEIPT OF MATERIAL</u></b></span></p>'+
				N'<p><span style="color:maroon; font-size: 8pt"><b>Lunes a Viernes | Monday to Friday: 7am -9am, 10am -2pm y 4pm -5:30pm</b></span></p>'


					EXEC msdb.dbo.sp_send_dbmail @recipients=@VP_RECIPIENTS,
					--@blind_copy_recipients='ALEJANDROD@PEARLLEATHER.COM.MX',
					@subject = @VP_SUBJECT,
					@body = @VP_BODY_HTML,  
					@body_format = 'HTML',
					@mailitem_id = @VP_ID_MAIL OUTPUT;
			END
		END
	-- ////////////////////////////////////////////////////////////////
	-- ///////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> UPDATE / PO
-- // PARA ACTUALIZAR EL ESTATUS DE LA PO DESDE LA PANTALL DE USUARIO QUE LA GENERA
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_UP_ESTATUS_PO_SEND_PRINT]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_UP_ESTATUS_PO_SEND_PRINT]
GO
--		 EXECUTE [dbo].[PG_UP_ESTATUS_PO_SEND_PRINT]	0,129,  6
--		 EXECUTE [dbo].[PG_UP_ESTATUS_PO_SEND_PRINT] 0,139, 9,0
--		 EXECUTE [PG_UP_ESTATUS_PO_SEND_PRINT] 1,139, 0,3
CREATE PROCEDURE [dbo].[PG_UP_ESTATUS_PO_SEND_PRINT]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT
AS
DECLARE @VP_MENSAJE					VARCHAR(500)=''
DECLARE @VP_L_IS_BLANKET			INT
DECLARE @VP_ESTATUS_PO_ORIGI		INT
DECLARE @VP_ESTATUS_PO_FINAL		INT = 6
DECLARE @PP_VP_K_LIVE				INT
-- /////////////////////////////////////////////////////////////////////
BEGIN TRANSACTION 
BEGIN TRY
	-- SE OBTIENE EL ESTATUS ORIGINAL PARA PODER REALIZAR LAS ACTUALIZACIONES DEL ESTATUS
	-- ADEMAS DE SABER SI ES BLANKET O NO.
	SELECT	@VP_ESTATUS_PO_ORIGI=K_STATUS_PURCHASE_ORDER,
			@VP_L_IS_BLANKET=L_IS_BLANKET
	FROM	HEADER_PURCHASE_ORDER	(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
	AND		L_BORRADO<>1

	IF @@ROWCOUNT = 0
		BEGIN
			--RAISERROR (@VP_ERROR_1, 16, 1 ) 
			SET @VP_MENSAJE='La [PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no se encuentra disponible...'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END			

	-- SE VERIFICA SI EL ESTATUS ESTA EN 6 ó 7 PARA PODER IMPRIMIR EL REPORTE, EN CASO CONTRARIO LO RECHAZA.
	IF	@VP_ESTATUS_PO_ORIGI NOT IN (6,7,11)
	BEGIN
		SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no disponible para imprimir...'
		RAISERROR (@VP_MENSAJE, 16, 1 ) 
	END
	ELSE
	BEGIN
		IF @VP_ESTATUS_PO_ORIGI=6
		BEGIN
			SET	@VP_ESTATUS_PO_FINAL = 7
		END
	END

	-- SI EL ESTATUS ES 6 Y EL K_PO ES DIFERENTE DE 0, ES PORQUE SE CAMBIO EL ESTATUS PERO NO SE IMPRIMIÓ.
	IF @VP_ESTATUS_PO_ORIGI=6 AND @PP_K_HEADER_PURCHASE_ORDER<>0
		BEGIN
			----================================================================
				--  SE ACTUALIZA EL REGISTRO PRINCIPAL DE LA ORDEN DE COMPRA.
				UPDATE	HEADER_PURCHASE_ORDER
				SET		
						K_STATUS_PURCHASE_ORDER =	@VP_ESTATUS_PO_FINAL
				WHERE	K_HEADER_PURCHASE_ORDER=	@PP_K_HEADER_PURCHASE_ORDER
				AND		[K_PO_TEMPORAL]=	@PP_K_PO_TEMPORAL

					IF @@ROWCOUNT = 0
						BEGIN
							--RAISERROR (@VP_ERROR_1, 16, 1 ) 
							SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no fue posible actualizar STATUS_PRINT & PO<>0'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END

				SET @PP_VP_K_LIVE= @PP_K_HEADER_PURCHASE_ORDER
				----================================================================			
		END
	ELSE IF @VP_ESTATUS_PO_ORIGI=6 AND @PP_K_HEADER_PURCHASE_ORDER=0
		BEGIN
			--	AQUI SE DEBE CAMBIAR LA K_DE LA PO Y DEJAR LA K QUE SERA LA PRODUCTIVA Y LA TEMPORAL DEBE REGRESAR A 0
			DECLARE @PP_VP_ULTIMO_REGISTRO INT		

			-- SE OBTIENE LA ULTIMA K_INSERTADA PARA ASIGNAR LA DISPONIBLE
			SELECT	TOP (1) @PP_VP_ULTIMO_REGISTRO= K_HEADER_PURCHASE_ORDER
			FROM	HEADER_PURCHASE_ORDER	(NOLOCK)
			ORDER BY K_HEADER_PURCHASE_ORDER DESC
			
			SET @PP_VP_K_LIVE = @PP_VP_ULTIMO_REGISTRO + 1
				----================================================================
				--  SE ACTUALIZA EL REGISTRO PRINCIPAL DE LA ORDEN DE COMPRA.
				UPDATE HEADER_PURCHASE_ORDER
				SET		
						K_STATUS_PURCHASE_ORDER =	@VP_ESTATUS_PO_FINAL,
						
						K_HEADER_PURCHASE_ORDER =	@PP_VP_K_LIVE,
						[K_PO_TEMPORAL]			=	0
				
				WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
				AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

					IF @@ROWCOUNT = 0
						BEGIN
							--RAISERROR (@VP_ERROR_1, 16, 1 ) 
							SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no se asignó un ID permanente al registro...'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END
				----================================================================
				----================================================================
				-- SE ACTUALIZAN LOS DETALLES DE LA ORDEN DE COMPRA.
				UPDATE [DETAILS_PURCHASE_ORDER]
				SET								
						K_HEADER_PURCHASE_ORDER =	@PP_VP_K_LIVE,
						[K_PO_TEMPORAL]			=	0				
				
				WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
				AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

					IF @@ROWCOUNT = 0
						BEGIN
							--RAISERROR (@VP_ERROR_1, 16, 1 ) 
							SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no se actualizaron los detalles de la orden...'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END
				----================================================================
				----================================================================
				-- SE ACTUALIZAN LOS DETALLES DE LA BLANKET_PO
				IF @VP_L_IS_BLANKET=1
				BEGIN
					UPDATE [DETAILS_BLANKET_PURCHASE_ORDER]
					SET								
							K_HEADER_PURCHASE_ORDER =	@PP_VP_K_LIVE,
							[K_PO_TEMPORAL]			=	0				
					
					WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
					AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

						IF @@ROWCOUNT = 0
							BEGIN
								--RAISERROR (@VP_ERROR_1, 16, 1 ) 
								SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no se actualizaron los detalles de la orden BLANKET...'
								RAISERROR (@VP_MENSAJE, 16, 1 ) 
							END
				END
				----================================================================
				----================================================================
				-- SE ACTUALIZA EL LOG DE COMENTARIOS
				UPDATE [PO_COMENTARIO_LOG]
				SET								
						K_HEADER_PURCHASE_ORDER =	@PP_VP_K_LIVE,
						[K_PO_TEMPORAL]			=	0				
				
				WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
				AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL

				----================================================================
				----================================================================
				-- SE ACTUALIZA EL VALOR DE LAS K_TEMPORALES Y SE VUELVE A PONER DISPONIBLE EL ID.
	
				UPDATE [HEADER_PURCHASE_ORDER_TEMP]
				SET								
						L_EN_USO =	0
				WHERE [K_HEADER_PURCHASE_ORDER_TEMP]=@PP_K_PO_TEMPORAL
				
					IF @@ROWCOUNT = 0
						BEGIN
							--RAISERROR (@VP_ERROR_1, 16, 1 ) 
							SET @VP_MENSAJE='[PO#'+CONVERT(VARCHAR(10),@PP_K_PO_TEMPORAL)+'] no se actualizó la tabla de ID_TEMP.'
							RAISERROR (@VP_MENSAJE, 16, 1 ) 
						END		
				----================================================================		
				SET @PP_K_PO_TEMPORAL=0
		END
	ELSE
		BEGIN
			SET @PP_VP_K_LIVE= @PP_K_HEADER_PURCHASE_ORDER
		END
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	/* Ocurrió un error, deshacemos los cambios*/ 
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH
-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] el [STATUS_PO]: ' + @VP_MENSAJE 
	END

	--SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	SELECT	@VP_MENSAJE AS MENSAJE, @PP_VP_K_LIVE	AS K_HEADER_LIVE, @PP_K_PO_TEMPORAL	AS K_HEADER_TEMP
	-- //////////////////////////////////////////////////////////////
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> DELETE / FICHA
-- //////////////////////////////////////////////////////////////
--	EXECUTE [dbo].[PG_DL_HEADER_PURCHASE_ORDER] 0,139,380,2,2
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_DL_HEADER_PURCHASE_ORDER]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_DL_HEADER_PURCHASE_ORDER]
GO
CREATE PROCEDURE [dbo].[PG_DL_HEADER_PURCHASE_ORDER]
	@PP_K_SISTEMA_EXE				INT,
	@PP_K_USUARIO_ACCION			INT,
	-- ===========================
	@PP_K_HEADER_PURCHASE_ORDER		INT,
	@PP_K_PO_TEMPORAL				INT
AS
DECLARE @VP_MENSAJE				VARCHAR(300) = ''
BEGIN TRANSACTION 
BEGIN TRY
--/////////////////////////////////////////////////////////////
	IF @VP_MENSAJE=''
	BEGIN
		EXECUTE [dbo].[PG_RN_PURCHASE_ORDER_DELETE]		@PP_K_SISTEMA_EXE, @PP_K_USUARIO_ACCION,
														@PP_K_HEADER_PURCHASE_ORDER,  @PP_K_PO_TEMPORAL,
														@OU_RESULTADO_VALIDACION = @VP_MENSAJE		OUTPUT
	END
	--////////////////////////////////////////////////////////////
	IF @VP_MENSAJE=''
	BEGIN		
		UPDATE	HEADER_PURCHASE_ORDER
		SET		
				[L_BORRADO]				= 1,
				[K_STATUS_PAID_ORDER]	= 0,
				-- ====================
				[F_BAJA]				= GETDATE(), 
				[K_USUARIO_BAJA]		= @PP_K_USUARIO_ACCION
		WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
		AND		[K_PO_TEMPORAL]=@PP_K_PO_TEMPORAL
		IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='La orden no puede ser eliminada. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			END
	END
-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	

	-- /////////////////////////////////////////////////////////////////////	
	IF @VP_MENSAJE<>''
	BEGIN
		SET		@VP_MENSAJE = 'No es posible [ACTUALIZAR] la [PO]: ' + @VP_MENSAJE 
	END

	SELECT	@VP_MENSAJE AS MENSAJE, @PP_K_HEADER_PURCHASE_ORDER AS CLAVE
	-- //////////////////////////////////////////////////////////////
	
	-- //////////////////////////////////////////////////////////////	
GO


-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> DELETE
-- // ELIMINA EL LOG DEL MATERIAL RECIBIDO, SE HACE INDIVIDUAL.
-- //////////////////////////////////////////////////////////////
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_DL_DETAILS_LOG]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_DL_DETAILS_LOG]
GO
--		 EXECUTE [dbo].[PG_DL_DETAILS_LOG] 0,139,  
CREATE PROCEDURE [dbo].[PG_DL_DETAILS_LOG]
	@PP_K_SISTEMA_EXE					INT,
	@PP_K_USUARIO_ACCION				INT,
	-- ===========================
	@PP_K_LOG_DETAILS_PURCHASE_ORDER	INT,
	@PP_K_HEADER_PURCHASE_ORDER			INT
AS
	DECLARE  @VP_MENSAJE				VARCHAR(300) = ''
			,@VP_STATUS_PO_IN_BD		INT

			,@VP_K_ITEM					INT

			,@VP_K_STATUS_FINAL			INT

			,@VP_QUANTITY_ORDER			DECIMAL(16,4)
			
			,@VP_RECIBIDA_ELIMINAR		DECIMAL(16,4)
			,@VP_PENDIENTE_ELIMINAR		DECIMAL(16,4)
BEGIN TRANSACTION 
BEGIN TRY
	-- ////////////////////////////////////////////////////////////////////
	--	SE VERIFICA EL STATUS DE LA ORDEN DE COMPRA
	SELECT	@VP_STATUS_PO_IN_BD	= K_STATUS_PURCHASE_ORDER
	FROM	HEADER_PURCHASE_ORDER	(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER	= @PP_K_HEADER_PURCHASE_ORDER

	IF	@VP_STATUS_PO_IN_BD	IN (12,13)
	BEGIN
		--	OBTENEMOS LOS DATOS DEL LOG PARA REGRESAR LAS CANTIDADES ORIGINALES
		SELECT	@VP_K_ITEM					= K_ITEM,
				@VP_QUANTITY_ORDER			= QUANTITY_ORDER,
				@VP_RECIBIDA_ELIMINAR		= QUANTITY_RECEIVED,
				@VP_PENDIENTE_ELIMINAR		= QUANTITY_PENDING
		FROM	LOG_DETAILS_PURCHASE_ORDER	(NOLOCK)
		WHERE	K_LOG_DETAILS_PURCHASE_ORDER	= @PP_K_LOG_DETAILS_PURCHASE_ORDER
		
		UPDATE	[DETAILS_PURCHASE_ORDER]
		SET		[QUANTITY_RECEIVED]	=	(	[QUANTITY_RECEIVED] - @VP_RECIBIDA_ELIMINAR	),
				[QUANTITY_PENDING]	=	(	[QUANTITY_PENDING] + @VP_RECIBIDA_ELIMINAR	)
		WHERE	K_HEADER_PURCHASE_ORDER = @PP_K_HEADER_PURCHASE_ORDER
		AND		K_ITEM = @VP_K_ITEM			
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='El registro no se pudó actualizar. [ITEM#'+CONVERT(VARCHAR(10),@VP_K_ITEM)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END

		DELETE	LOG_DETAILS_PURCHASE_ORDER
		WHERE	K_LOG_DETAILS_PURCHASE_ORDER	= @PP_K_LOG_DETAILS_PURCHASE_ORDER
		IF @@ROWCOUNT = 0
		BEGIN
			SET @VP_MENSAJE='El LOG del registro no se pudó eliminar. [ITEM#'+CONVERT(VARCHAR(10),@VP_K_ITEM)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 ) 
		END

	-- ///////////////////////////////////////////
	DECLARE		 @VP_SUMA_PENDIENTES			DECIMAL(16,4)	=-1
				,@VP_SUMA_RECIBIDOS				DECIMAL(16,4)	= 0
	
	SELECT	@VP_SUMA_PENDIENTES		= SUM(QUANTITY_PENDING),
			@VP_SUMA_RECIBIDOS		= SUM(QUANTITY_RECEIVED)
	FROM	DETAILS_PURCHASE_ORDER	(NOLOCK)
	WHERE	K_HEADER_PURCHASE_ORDER=@PP_K_HEADER_PURCHASE_ORDER
	AND		[K_PO_TEMPORAL]=0
	
		IF @VP_SUMA_PENDIENTES IS NULL	OR	@VP_SUMA_RECIBIDOS IS NULL
		BEGIN
			SET @VP_MENSAJE='No fue posible obtener los totales para actualizar el STATUS. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
			RAISERROR (@VP_MENSAJE, 16, 1 )
		END
		
		IF	@VP_SUMA_RECIBIDOS	= 0
		BEGIN
			SET		@VP_K_STATUS_FINAL	= 11
			UPDATE	[HEADER_PURCHASE_ORDER]
			SET		[K_STATUS_PURCHASE_ORDER]	= @VP_K_STATUS_FINAL,
					[F_RECEIVED_PURCHASE_ORDER]	= NULL,
					[F_PROMISE_PURCHASE_ORDER]	= NULL
			WHERE	[K_HEADER_PURCHASE_ORDER]	= @PP_K_HEADER_PURCHASE_ORDER
			AND		[K_PO_TEMPORAL]				= 0
			IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='El STATUS(11) no fue actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END
		END
		ELSE
		BEGIN
			SET		@VP_K_STATUS_FINAL	= 13
			UPDATE	[HEADER_PURCHASE_ORDER]
			SET		[K_STATUS_PURCHASE_ORDER]	= @VP_K_STATUS_FINAL
					--[F_RECEIVED_PURCHASE_ORDER]	= GETDATE(),
					--[F_PROMISE_PURCHASE_ORDER]	= GETDATE()
			WHERE	[K_HEADER_PURCHASE_ORDER]=@PP_K_HEADER_PURCHASE_ORDER
			AND		[K_PO_TEMPORAL]				= 0
			IF @@ROWCOUNT = 0
			BEGIN
				SET @VP_MENSAJE='El STATUS(13) no fue actualizado. [PO#'+CONVERT(VARCHAR(10),@PP_K_HEADER_PURCHASE_ORDER)+']'
				RAISERROR (@VP_MENSAJE, 16, 1 ) 
			END
		END
	END
	ELSE
	BEGIN
		RAISERROR ('El status de la PO no permite realizar la acción, informe a sistemas...', 16, 1 ) 
	END

-- /////////////////////////////////////////////////////////////////////
COMMIT TRANSACTION 
END TRY

BEGIN CATCH
	ROLLBACK TRANSACTION
	DECLARE @VP_ERROR_TRANS NVARCHAR(4000);
	SET @VP_ERROR_TRANS = ERROR_MESSAGE() 
	SET @VP_MENSAJE = 'ERROR:// ' + @VP_ERROR_TRANS
END CATCH	

	SELECT @VP_MENSAJE AS MENSAJE, @VP_K_STATUS_FINAL AS K_STATUS_PO
	-- ////////////////////////////////////////////////////////////////////
GO
-- //////////////////////////////////////////////////////////////
-- //////////////////////////////////////////////////////////////