-- //////////////////////////////////////////////////////////////
-- // ARCHIVO:			
-- //////////////////////////////////////////////////////////////
-- // BASE DE DATOS:	[DATA_02Pruebas]
-- // MODULO:			EMBARQUES
-- // OPERACION:		LIBERACION / REGLAS DE NEGOCIO
-- //////////////////////////////////////////////////////////////
-- // Autor:			FEG
-- // Fecha creaciÃ³n:	12/11/2020
-- ////////////////////////////////////////////////////////////// 

USE [DATA_02] 
GO

-- //////////////////////////////////////////////////////////////




-- //////////////////////////////////////////////////////////////
-- // STORED PROCEDURE ---> 
-- //////////////////////////////////////////////////////////////

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PG_RN_MERMA_LOTE_COMPRADO]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[PG_RN_MERMA_LOTE_COMPRADO]
GO
/*
 USE [DATA_02Pruebas]  
*/

CREATE PROCEDURE [dbo].[PG_RN_MERMA_LOTE_COMPRADO]
	@PP_K_SISTEMA_EXE			INT,
	@PP_K_USUARIO_ACCION		INT,
	-- ===========================		
	@PP_COLOR					VARCHAR(50),
	@PP_LOT_CRUST				VARCHAR(50),
	@OU_RESULTADO_VALIDACION	VARCHAR(300)	OUTPUT
	-- ===========================		
AS

	DECLARE @VP_RESULTADO		VARCHAR(300) = '' 
	DECLARE @VP_N_COLOR			INT = 0
	DECLARE @VP_N_LOT_CRUST		INT = 0
	-- /////////////////////////////////////////////////////
	
	IF @VP_RESULTADO = ''
		BEGIN
			
			SELECT	@VP_N_COLOR = COUNT(A4GLIDENTITY)
			FROM	IMITMIDX_SQL 
			WHERE	LTRIM(RTRIM(item_no)) = @PP_COLOR

			-- /////////////////////////////////////////////////////
			IF @VP_N_COLOR IS NULL OR @VP_N_COLOR = ''
				SET @VP_N_COLOR = 0

			IF @VP_N_COLOR = 0
				SET @VP_RESULTADO = 'El codigo de color : ' + @PP_COLOR + ' no existe.'
		END

	IF @VP_RESULTADO = ''
		BEGIN
			SELECT	@VP_N_LOT_CRUST = COUNT(K_MERMA_LOTE_COMPRADO)
			FROM	MERMA_LOTE_COMPRADO 
			WHERE	LOT_CRUST = @PP_LOT_CRUST

			-- /////////////////////////////////////////////////////
			IF @VP_N_LOT_CRUST IS NULL OR @VP_N_LOT_CRUST = ''
				SET @VP_N_LOT_CRUST = 0

			IF @VP_N_LOT_CRUST > 0
				SET @VP_RESULTADO = 'El Lot Crust : ' + @PP_LOT_CRUST + ' ya existe.'
		END

	-- /////////////////////////////////////////////////////
	
	SET @OU_RESULTADO_VALIDACION = @VP_RESULTADO

	-- /////////////////////////////////////////////////////
GO




-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////
-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////
-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////
-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////
-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////
